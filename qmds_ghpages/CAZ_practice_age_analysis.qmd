---
title: "CAZ_prescription_trends"
---

## Overview

TBC

## Setup

### Package Installation

Loading required packages for data analysis and visualisation.

```{r}
#| label: packages
#| message: false

options(repos = c(CRAN = "https://cloud.r-project.org"))
if (!require("remotes")) {
  install.packages("remotes")
}
pkgs = c(
  "sf",
  "tidyverse",
  "here",
  "tmap",
  "data.table"
)

remotes::install_cran(pkgs)
sapply(pkgs, require, character.only = TRUE)

```

## Loading data

### GP practices

Loading spatial and administrative data for GP practices and CAZ areas.

```{r}
#| label: read-data-pract
subicb_boundaries <- st_read(file.path(
  here(),
  "data_raw",
  "subicb_boundaries.gpkg"
))
pract_classed <- st_read("data_raw/CAZ_practices.gpkg")
all_practices <- st_read(file.path(here(), "data_raw", "gp_locations.gpkg"))
CAZ_lst <- read_csv("data_raw/CAZ_list.csv")
```

### Patient data

Loading patient registration data for calculating prescription rates.

```{r}
#| label: read-data-patients

patient_age_df <- read_csv("data_raw/practice_patients_age.csv")

patient_avg_age <- as.data.table(patient_age_df)[,
  `:=`(
    lower = as.numeric(str_extract(AGE_GROUP, "(?<=(\\(|\\[))\\d{1,2}")),
    upper = as.numeric(str_extract(AGE_GROUP, "\\d{2,3}(?=(\\)|\\]))"))
  )
][,
  midpoint := 0.5 * (lower + upper)
][,
  .(mean_age = weighted.mean(midpoint, NUMBER_OF_PATIENTS)),
  by = .(ORG_CODE, month, year)
][ORG_CODE %in% pract_classed$code]

patient_avg_age$month <- match(patient_avg_age$month, tolower(month.name))
```

A quick exploration of the mean age of patients for different CAZ boundaries

```{r}
#| label: map-ages

tmap_mode("view")

pract_classed |> inner_join(patient_avg_age |>
      filter(year == 2024, month == 12),
    by = c("code" = "ORG_CODE")
  ) |>
  tm_shape() +
  tm_dots("mean_age")


```
```{r}

pract_classed |>
  inner_join(
    patient_avg_age |>
      filter(year == 2024, month == 12),
    by = c("code" = "ORG_CODE")
  ) |>
  ggplot(aes(x = factor(buffer_km), y = mean_age)) +
  geom_jitter(alpha = 0.2, col = "dodgerblue") +
  geom_boxplot(outlier.shape = NA, varwidth = TRUE) +
  facet_wrap(CAZ_name ~ .)

```