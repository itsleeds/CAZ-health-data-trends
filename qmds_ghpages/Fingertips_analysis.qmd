---
title: "Analysis of Fingertips data"
---

This file presents an analysis of hospital admissions data for districts with Clean Air Zones (CAZ) in England. The aim is to explore health trends, focusing on hospital admissions of under-19-year-olds, and to visualise geographical and temporal patterns using publicly available datasets.


## Setup

### Package Installation

Loading required packages for data analysis and visualisation.

```{r}
#| label: packages
#| message: false

options(repos = c(CRAN = "https://cloud.r-project.org"))
if (!require("remotes")) {
  install.packages("remotes")
}
pkgs <- c(
  "sf",
  "tidyverse",
  "here",
  "tmap",
  "data.table",
  "plotly"
)

remotes::install_cran(pkgs)
sapply(pkgs, require, character.only = TRUE)

```

## Loading data

### Hospital Admissions Data

We use hospital admissions data sourced from the Fingertips platform, which provides a wide range of public health indicators. The dataset includes information on admissions by area, age, sex, and time period, allowing for detailed analysis of health outcomes.

```{r}
admissions_data <- read_csv(
  "data_raw/hospital_admissions.csv",
  col_types = cols(
    IndicatorID = col_double(),
    IndicatorName = col_character(),
    ParentCode = col_character(),
    ParentName = col_character(),
    AreaCode = col_character(),
    AreaName = col_character(),
    AreaType = col_character(),
    Sex = col_character(),
    Age = col_character(),
    CategoryType = col_logical(),
    Category = col_logical(),
    Timeperiod = col_character(),
    Value = col_double(),
    LowerCI95.0limit = col_double(),
    UpperCI95.0limit = col_double(),
    LowerCI99.8limit = col_double(),
    UpperCI99.8limit = col_double(),
    Count = col_double(),
    Denominator = col_double(),
    Valuenote = col_character(),
    RecentTrend = col_character(),
    ComparedtoEnglandvalueorpercentiles = col_character(),
    ComparedtoParentvalueorpercentiles = col_character(),
    TimeperiodSortable = col_double(),
    Newdata = col_logical(),
    Comparedtogoal = col_logical(),
    Timeperiodrange = col_character()
  )
)
```

### Geographical Data

#### CAZ Boundaries

Spatial boundaries for Clean Air Zones are loaded from a GeoPackage file. These boundaries define the areas where interventions to improve air quality have been implemented.

```{r}
caz_boundaries <- st_read(file.path(here(), "data_raw", "CAZ_boundaries.gpkg"))
```

#### Local Authority District Boundaries

Local Authority District (LAD) boundaries are obtained from the ONS GeoPortal and downloaded if not already present. These boundaries are used to identify which districts intersect with CAZ areas.

```{r}
if (!file.exists("data_raw/LAD_MAY_2025_UK_BFC_V2_6634550694215771101.gpkg")) {
  url <- "https://github.com/itsleeds/CAZ-health-data-trends/releases/download/v0/LAD_MAY_2025_UK_BFC_V2_6634550694215771101.gpkg"

  download.file(
    url,
    destfile = "data_raw/LAD_MAY_2025_UK_BFC_V2_6634550694215771101.gpkg",
    mode = "wb"
  )
}

la_boundaries <- st_read(
  "data_raw/LAD_MAY_2025_UK_BFC_V2_6634550694215771101.gpkg",
  quiet = TRUE
)
```

## Pre-processing

### Identifying Districts with CAZ Coverage

To focus the analysis on relevant areas, we identify LADs that overlap with CAZ boundaries. This spatial join ensures that subsequent analyses are restricted to districts affected by CAZ interventions.

```{r}
CAZ_la_boundaries <- la_boundaries[caz_boundaries, ]
```

### Visualising CAZ Locations

We create an interactive map to visualise the location of CAZ districts within England. This helps contextualise the analysis and provides a geographical overview of the study area.

```{r}
tmap_mode("view")

tm_shape(CAZ_la_boundaries) +
  tm_polygons("grey70") +
  tm_shape(caz_boundaries) +
  tm_polygons("blue", fill_alpha = 0.6)
```

### Subsetting Admissions Data

The admissions data is filtered to include only records from districts with CAZ coverage. This step ensures that our health trend analysis is specific to the population impacted by CAZ policies.

```{r}
CAZ_admissions <- admissions_data |>
  filter(AreaCode %in% CAZ_la_boundaries$LAD25CD)
```

## Visualising Trends

### Hospital Admissions Over Time

We plot hospital admissions for under-19-year-olds across CAZ districts, grouped by age and area. The interactive plot allows exploration of temporal trends and comparisons between districts, supporting further investigation into the impact of CAZ interventions on health outcomes.

```{r}
admissions_plot <- CAZ_admissions |>
  filter(Sex == "Persons") |>
  ggplot(aes(x = TimeperiodSortable, y = Value, col = AreaName)) +
  scale_x_continuous(breaks = unique(CAZ_admissions$TimeperiodSortable)) +
  geom_line() +
  facet_grid(Age ~ ., scales = "free_y") +
  theme_light() +
  scale_color_discrete(type = "qual", palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(
    title = "Hospital Admissions for Under 19-years-olds",
    y = "per 100,000",
    x = NULL
  )

ggplotly(admissions_plot)
```