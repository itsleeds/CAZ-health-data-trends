---
title: "fingertips_data"
format: html
---

## Overview

This section accesses and analyses public health data from NHS Digital's Fingertips platform. Fingertips provides a comprehensive collection of health indicators at various geographic levels, making it an invaluable resource for understanding population health patterns.

For this CAZ health analysis, we focus particularly on respiratory health indicators including:

- **Asthma prevalence**: Recorded prevalence of asthma in different age groups
- **Hospital admissions**: Emergency admissions for respiratory conditions
- **Air quality measures**: Local pollution levels and monitoring data
- **Mortality indicators**: Deaths attributable to respiratory diseases

The Fingertips API allows us to access standardized health indicators that can be compared across different geographic areas and time periods. This provides important contextual information for understanding the baseline health status of populations in CAZ areas compared to control areas.

By combining Fingertips data with our prescription analysis, we can build a more complete picture of respiratory health trends and validate our findings against established public health surveillance systems.

```{r}
#| label: packages
#| message: false

options(repos = c(CRAN = "https://cloud.r-project.org"))
if (!require("remotes")) {
  install.packages("remotes")
}
pkgs = c(
  "sf",
  "tidyverse",
  "here",
  "tmap"
)

remotes::install_cran(pkgs)
sapply(pkgs, require, character.only = TRUE)

if (!("fingertipsR" %in% installed.packages())) {
  remotes::install_github(
    "rOpenSci/fingertipsR",
    build_vignettes = TRUE,
    quiet = TRUE
  )
}

library(fingertipsR)
```

## Data Acquisition

### Profile Discovery

Retrieving the complete list of available health data profiles from the Fingertips platform.

```{r}
profile_lst <- profiles()
head(profile_lst)
```

### Asthma Indicators

Extracting health indicators specifically for asthma conditions using domain code 8000009.

```{r}
indicator_lst_asthma <- indicators(DomainID = 8000009)

indicator_lst_asthma |>
  head(10) |>
  knitr::kable()
```

### Respiratory Disease Indicators

Obtaining indicators for broader respiratory diseases using profile code 29.

```{r}
indicator_lst_resp <- indicators(ProfileID = 29)

indicator_lst_resp |>
  head(10) |>
  knitr::kable()
```

### Indicator Selection

Creating an object for the Hospital Admissions indicator.

```{r}
# sel_indicator <- indicator_lst_resp |>
#   pull(IndicatorID)

sel_indicator <- 90810
```

### Area Type Mapping

Determining which geographic area types are available for the selected health indicator.

```{r}
area_avail_ind <- do.call(
  bind_rows,
  lapply(sel_indicator, \(x) indicator_areatypes(IndicatorID = x))
)
```

### Geographic Classifications

Retrieving all available area type classifications for spatial analysis.

```{r}
area_ty_lst <- area_types()
```

### Data Integration

Joining indicator and area type information with descriptive names for clarity.

```{r}
area_avail_ind_names <- area_avail_ind |>
  left_join(
    indicator_lst_resp |>
      select(IndicatorID, IndicatorName) |>
      unique(),
    by = join_by(IndicatorID)
  ) |>
  left_join(
    area_ty_lst |>
      select(AreaTypeID, AreaTypeName) |>
      unique(),
    by = join_by(AreaTypeID)
  )

slice_sample(area_avail_ind_names, n = 15) |>
  select(-IndicatorID, -AreaTypeID) |>
  knitr::kable()
```

### Sample Data Extraction

Downloading actual data for the indicator Lower and Upper tier LAs.

```{r}
temp_data <- fingertips_data(
  IndicatorID = area_avail_ind$IndicatorID[1],
  AreaTypeID = "All"
)

temp_data |> sample_n(10) |> knitr::kable()

```

```{r}
write_csv(temp_data, "data_raw/hospital_admissions.csv", append = F)
```

