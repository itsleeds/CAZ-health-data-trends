[
  {
    "objectID": "qmds_ghpages/prescription_data.html",
    "href": "qmds_ghpages/prescription_data.html",
    "title": "prescription_data",
    "section": "",
    "text": "This section handles the acquisition and processing of prescription data from NHS England, focusing particularly on medications relevant to respiratory health. The primary focus is on Short-Acting Beta Agonists (SABA), which are commonly prescribed rescue inhalers for asthma and other respiratory conditions.\nThe prescription data is sourced from OpenPrescribing.net, which provides monthly prescribing data for all NHS practices in England. This allows us to:\n\nTrack prescription trends over time across different geographic areas\nCompare prescribing patterns between CAZ and non-CAZ areas\nAdjust for population size using patient registration data\nIdentify potential changes in respiratory health following CAZ implementation\n\nThis analysis forms the core of our investigation into the potential health impacts of Clean Air Zones.",
    "crumbs": [
      "Data",
      "Prescriptions"
    ]
  },
  {
    "objectID": "qmds_ghpages/prescription_data.html#overview",
    "href": "qmds_ghpages/prescription_data.html#overview",
    "title": "prescription_data",
    "section": "",
    "text": "This section handles the acquisition and processing of prescription data from NHS England, focusing particularly on medications relevant to respiratory health. The primary focus is on Short-Acting Beta Agonists (SABA), which are commonly prescribed rescue inhalers for asthma and other respiratory conditions.\nThe prescription data is sourced from OpenPrescribing.net, which provides monthly prescribing data for all NHS practices in England. This allows us to:\n\nTrack prescription trends over time across different geographic areas\nCompare prescribing patterns between CAZ and non-CAZ areas\nAdjust for population size using patient registration data\nIdentify potential changes in respiratory health following CAZ implementation\n\nThis analysis forms the core of our investigation into the potential health impacts of Clean Air Zones.",
    "crumbs": [
      "Data",
      "Prescriptions"
    ]
  },
  {
    "objectID": "qmds_ghpages/prescription_data.html#setup",
    "href": "qmds_ghpages/prescription_data.html#setup",
    "title": "prescription_data",
    "section": "Setup",
    "text": "Setup\n\nPackage Installation\nLoading required packages for spatial analysis and web scraping.\n\n\nShow the code\noptions(repos = c(CRAN = \"https://cloud.r-project.org\"))\nif (!require(\"remotes\")) {\n  install.packages(\"remotes\")\n}\npkgs = c(\n  \"sf\",\n  \"tidyverse\",\n  \"here\",\n  \"tmap\",\n  \"geojsonsf\",\n  \"rvest\"\n)\n\nremotes::install_cran(pkgs)\nsapply(pkgs, require, character.only = TRUE)\n\n\n       sf tidyverse      here      tmap geojsonsf     rvest \n     TRUE      TRUE      TRUE      TRUE      TRUE      TRUE",
    "crumbs": [
      "Data",
      "Prescriptions"
    ]
  },
  {
    "objectID": "qmds_ghpages/prescription_data.html#downloading-data",
    "href": "qmds_ghpages/prescription_data.html#downloading-data",
    "title": "prescription_data",
    "section": "Downloading data",
    "text": "Downloading data\nLoading Sub-ICB boundary data for geographic reference.\n\n\nShow the code\nsubicb_boundaries &lt;- st_read(file.path(\n  here(),\n  \"data_raw\",\n  \"subicb_boundaries.gpkg\"\n))\n\n\nReading layer `subicb_boundaries' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\subicb_boundaries.gpkg' \n  using driver `GPKG'\nSimple feature collection with 106 features and 4 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 87318.43 ymin: 7053.782 xmax: 655646.4 ymax: 657547.7\nProjected CRS: OSGB36 / British National Grid\n\n\n\nSABA\nDownloading SABA prescription data from OpenPrescribing for all Sub-ICB areas.\n\n\nShow the code\nif (!file.exists(file.path(here(), \"data_raw\", \"all_saba.csv\"))) {\n  all_saba_raw &lt;- do.call(\n    bind_rows,\n    lapply(subicb_boundaries$code, \\(t_code) {\n      read_csv(\n        paste0(\n          \"https://openprescribing.net/api/1.0/measure_by_practice/?format=csv&org=\",\n          t_code,\n          \"&parent_org_type=ccg&measure=saba\"\n        ),\n        col_types = cols(\n          measure = col_character(),\n          org_type = col_character(),\n          org_id = col_character(),\n          org_name = col_character(),\n          date = col_date(format = \"\"),\n          numerator = col_double(),\n          denominator = col_double(),\n          calc_value = col_double(),\n          percentile = col_double()\n        )\n      )\n    })\n  )\n  write_csv(all_saba_raw, file = file.path(here(), \"data_raw\", \"all_saba.csv\"))\n} else {\n  all_saba_raw &lt;- read_csv(file = file.path(here(), \"data_raw\", \"all_saba.csv\"))\n}",
    "crumbs": [
      "Data",
      "Prescriptions"
    ]
  },
  {
    "objectID": "qmds_ghpages/prescription_data.html#all-bnf-groups",
    "href": "qmds_ghpages/prescription_data.html#all-bnf-groups",
    "title": "prescription_data",
    "section": "All BNF groups",
    "text": "All BNF groups\n\nBNF Code Discovery\nExtracting all available BNF codes from the OpenPrescribing website for comprehensive data download.\n\n\nShow the code\nbase_u &lt;- \"https://openprescribing.net/bnf/\"\nbnf_site &lt;- read_html(base_u)\n\nlinks &lt;- bnf_site |&gt; html_nodes(\"a\") |&gt; html_attr(\"href\")\nlinks &lt;- links[grep(\"/bnf/\\\\d{2,6}/$\", links)] |&gt;\n  str_remove(\"/bnf/\") |&gt;\n  str_remove(\"/$\")\nlinks &lt;- links[order(nchar(links))]\n\ndates &lt;- seq(as.Date(\"2020-08-01\"), as.Date(\"2025-03-01\"), \"months\")\n\nfull_data_grid &lt;- expand_grid(code = links, date = dates) |&gt;\n  mutate(group = nchar(code), file.name = paste0(code, \"_\", date, \".csv\"))\n\nwrite_rds(full_data_grid, file = \"data_raw/full_bnf_grid.rds\")\n\nlimit_group2 &lt;- full_data_grid |&gt; filter(group == 2) |&gt; nrow()\n\n\n## This is to be run\ndir.create(\"data_raw/bnf_all\", showWarnings = F)\nall_bnf_codes &lt;- lapply(seq_len(limit_group2), \\(x) {\n  if (\n    !file.exists(file.path(\"data_raw\", \"bnf_all\", full_data_grid$file.name[x]))\n  ) {\n    download.file(\n      paste0(\n        \"https://openprescribing.net/api/1.0/spending_by_org/?org_type=practice&code=\",\n        full_data_grid$code[x],\n        \"&date=\",\n        full_data_grid$date[x],\n        \"&format=csv\"\n      ),\n      destfile = file.path(\"data_raw\", \"bnf_all\", full_data_grid$file.name[x]),\n      mode = \"wb\"\n    )\n  }\n})\n\n\n\n\nMontelukast\n\n\nShow the code\nmont_data_grid &lt;- expand_grid(code = \"0303020G0\", date = dates) |&gt;\n  mutate(group = nchar(code), file.name = paste0(code, \"_\", date, \".csv\"))\n\n\ndir.create(\"data_raw/bnf_all\", showWarnings = F)\nall_bnf_codes &lt;- lapply(seq_len(mont_data_grid |&gt; nrow()), \\(x) {\n  if (\n    !file.exists(file.path(\"data_raw\", \"bnf_all\", mont_data_grid$file.name[x]))\n  ) {\n    download.file(\n      paste0(\n        \"https://openprescribing.net/api/1.0/spending_by_org/?org_type=practice&code=\",\n        mont_data_grid$code[x],\n        \"&date=\",\n        mont_data_grid$date[x],\n        \"&format=csv\"\n      ),\n      destfile = file.path(\"data_raw\", \"bnf_all\", mont_data_grid$file.name[x]),\n      mode = \"wb\"\n    )\n  }\n})",
    "crumbs": [
      "Data",
      "Prescriptions"
    ]
  },
  {
    "objectID": "qmds_ghpages/index.html",
    "href": "qmds_ghpages/index.html",
    "title": "CAZ-health-data-trends",
    "section": "",
    "text": "This website presents an analysis of health data trends in relation to Clean Air Zones (CAZ) across the UK. Clean Air Zones are areas where targeted action is taken to improve air quality, particularly by discouraging the most polluting vehicles from entering zone boundaries.\nThis study investigates potential relationships between the implementation of Clean Air Zones and health outcomes, particularly focusing on respiratory conditions such as asthma. The analysis combines prescription data, practice-level patient information, and geographic boundaries to understand spatial patterns and temporal trends.\nThe site is organised into several key sections:\n\nCAZ Definition: Details about Clean Air Zone boundaries and data sources\nPractice Data: Information about GP practices and their geographic locations\n\nPrescription Data: Analysis of prescription patterns, particularly SABA (Short-Acting Beta Agonists) inhalers for asthma\nFingertips Data: Public health indicators from NHS Digital’s Fingertips platform\nCAZ Prescription Trends: Comprehensive analysis of prescription trends in relation to Clean Air Zones\n\nThis research aims to provide evidence-based insights into the potential health impacts of air quality interventions in urban areas.",
    "crumbs": [
      "Home"
    ]
  },
  {
    "objectID": "qmds_ghpages/index.html#introduction",
    "href": "qmds_ghpages/index.html#introduction",
    "title": "CAZ-health-data-trends",
    "section": "",
    "text": "This website presents an analysis of health data trends in relation to Clean Air Zones (CAZ) across the UK. Clean Air Zones are areas where targeted action is taken to improve air quality, particularly by discouraging the most polluting vehicles from entering zone boundaries.\nThis study investigates potential relationships between the implementation of Clean Air Zones and health outcomes, particularly focusing on respiratory conditions such as asthma. The analysis combines prescription data, practice-level patient information, and geographic boundaries to understand spatial patterns and temporal trends.\nThe site is organised into several key sections:\n\nCAZ Definition: Details about Clean Air Zone boundaries and data sources\nPractice Data: Information about GP practices and their geographic locations\n\nPrescription Data: Analysis of prescription patterns, particularly SABA (Short-Acting Beta Agonists) inhalers for asthma\nFingertips Data: Public health indicators from NHS Digital’s Fingertips platform\nCAZ Prescription Trends: Comprehensive analysis of prescription trends in relation to Clean Air Zones\n\nThis research aims to provide evidence-based insights into the potential health impacts of air quality interventions in urban areas.",
    "crumbs": [
      "Home"
    ]
  },
  {
    "objectID": "qmds_ghpages/Fingertips_analysis.html",
    "href": "qmds_ghpages/Fingertips_analysis.html",
    "title": "Analysis of Fingertips data",
    "section": "",
    "text": "This file presents an analysis of hospital admissions data for districts with Clean Air Zones (CAZ) in England. The aim is to explore health trends, focusing on hospital admissions of under-19-year-olds, and to visualise geographical and temporal patterns using publicly available datasets.",
    "crumbs": [
      "Analysis",
      "Under 19 yrs hospital admissions for asthma"
    ]
  },
  {
    "objectID": "qmds_ghpages/Fingertips_analysis.html#setup",
    "href": "qmds_ghpages/Fingertips_analysis.html#setup",
    "title": "Analysis of Fingertips data",
    "section": "Setup",
    "text": "Setup\n\nPackage Installation\nLoading required packages for data analysis and visualisation.\n\n\nShow the code\noptions(repos = c(CRAN = \"https://cloud.r-project.org\"))\nif (!require(\"remotes\")) {\n  install.packages(\"remotes\")\n}\npkgs &lt;- c(\n  \"sf\",\n  \"tidyverse\",\n  \"here\",\n  \"tmap\",\n  \"data.table\",\n  \"plotly\"\n)\n\nremotes::install_cran(pkgs)\nsapply(pkgs, require, character.only = TRUE)\n\n\n        sf  tidyverse       here       tmap data.table     plotly \n      TRUE       TRUE       TRUE       TRUE       TRUE       TRUE",
    "crumbs": [
      "Analysis",
      "Under 19 yrs hospital admissions for asthma"
    ]
  },
  {
    "objectID": "qmds_ghpages/Fingertips_analysis.html#loading-data",
    "href": "qmds_ghpages/Fingertips_analysis.html#loading-data",
    "title": "Analysis of Fingertips data",
    "section": "Loading data",
    "text": "Loading data\n\nHospital Admissions Data\nWe use hospital admissions data sourced from the Fingertips platform, which provides a wide range of public health indicators. The dataset includes information on admissions by area, age, sex, and time period, allowing for detailed analysis of health outcomes.\n\n\nShow the code\nadmissions_data &lt;- read_csv(\n  \"data_raw/hospital_admissions.csv\",\n  col_types = cols(\n    IndicatorID = col_double(),\n    IndicatorName = col_character(),\n    ParentCode = col_character(),\n    ParentName = col_character(),\n    AreaCode = col_character(),\n    AreaName = col_character(),\n    AreaType = col_character(),\n    Sex = col_character(),\n    Age = col_character(),\n    CategoryType = col_logical(),\n    Category = col_logical(),\n    Timeperiod = col_character(),\n    Value = col_double(),\n    LowerCI95.0limit = col_double(),\n    UpperCI95.0limit = col_double(),\n    LowerCI99.8limit = col_double(),\n    UpperCI99.8limit = col_double(),\n    Count = col_double(),\n    Denominator = col_double(),\n    Valuenote = col_character(),\n    RecentTrend = col_character(),\n    ComparedtoEnglandvalueorpercentiles = col_character(),\n    ComparedtoParentvalueorpercentiles = col_character(),\n    TimeperiodSortable = col_double(),\n    Newdata = col_logical(),\n    Comparedtogoal = col_logical(),\n    Timeperiodrange = col_character()\n  )\n)\n\n\n\n\nGeographical Data\n\nCAZ Boundaries\nSpatial boundaries for Clean Air Zones are loaded from a GeoPackage file. These boundaries define the areas where interventions to improve air quality have been implemented.\n\n\nShow the code\ncaz_boundaries &lt;- st_read(file.path(here(), \"data_raw\", \"CAZ_boundaries.gpkg\"))\n\n\nReading layer `CAZ_boundaries' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\CAZ_boundaries.gpkg' \n  using driver `GPKG'\nSimple feature collection with 7 features and 1 field\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 356346.4 ymin: 99474.13 xmax: 465151.9 ymax: 565398\nProjected CRS: OSGB36 / British National Grid\n\n\n\n\nLocal Authority District Boundaries\nLocal Authority District (LAD) boundaries are obtained from the ONS GeoPortal and downloaded if not already present. These boundaries are used to identify which districts intersect with CAZ areas.\n\n\nShow the code\nif (!file.exists(\"data_raw/LAD_MAY_2025_UK_BFC_V2_6634550694215771101.gpkg\")) {\n  url &lt;- \"https://github.com/itsleeds/CAZ-health-data-trends/releases/download/v0/LAD_MAY_2025_UK_BFC_V2_6634550694215771101.gpkg\"\n\n  download.file(\n    url,\n    destfile = \"data_raw/LAD_MAY_2025_UK_BFC_V2_6634550694215771101.gpkg\",\n    mode = \"wb\"\n  )\n}\n\nla_boundaries &lt;- st_read(\n  \"data_raw/LAD_MAY_2025_UK_BFC_V2_6634550694215771101.gpkg\",\n  quiet = TRUE\n)",
    "crumbs": [
      "Analysis",
      "Under 19 yrs hospital admissions for asthma"
    ]
  },
  {
    "objectID": "qmds_ghpages/Fingertips_analysis.html#pre-processing",
    "href": "qmds_ghpages/Fingertips_analysis.html#pre-processing",
    "title": "Analysis of Fingertips data",
    "section": "Pre-processing",
    "text": "Pre-processing\n\nIdentifying Districts with CAZ Coverage\nTo focus the analysis on relevant areas, we identify LADs that overlap with CAZ boundaries. This spatial join ensures that subsequent analyses are restricted to districts affected by CAZ interventions.\n\n\nShow the code\nCAZ_la_boundaries &lt;- la_boundaries[caz_boundaries, ]\n\n\n\n\nVisualising CAZ Locations\nWe create an interactive map to visualise the location of CAZ districts within England. This helps contextualise the analysis and provides a geographical overview of the study area.\n\n\nShow the code\ntmap_mode(\"view\")\n\ntm_shape(CAZ_la_boundaries) +\n  tm_polygons(\"grey70\") +\n  tm_shape(caz_boundaries) +\n  tm_polygons(\"blue\", fill_alpha = 0.6)\n\n\n\n\n\n\n\n\nSubsetting Admissions Data\nThe admissions data is filtered to include only records from districts with CAZ coverage. This step ensures that our health trend analysis is specific to the population impacted by CAZ policies.\n\n\nShow the code\nCAZ_admissions &lt;- admissions_data |&gt;\n  filter(AreaCode %in% CAZ_la_boundaries$LAD25CD)",
    "crumbs": [
      "Analysis",
      "Under 19 yrs hospital admissions for asthma"
    ]
  },
  {
    "objectID": "qmds_ghpages/Fingertips_analysis.html#visualising-trends",
    "href": "qmds_ghpages/Fingertips_analysis.html#visualising-trends",
    "title": "Analysis of Fingertips data",
    "section": "Visualising Trends",
    "text": "Visualising Trends\n\nHospital Admissions Over Time\nWe plot hospital admissions for under-19-year-olds across CAZ districts, grouped by age and area. The interactive plot allows exploration of temporal trends and comparisons between districts, supporting further investigation into the impact of CAZ interventions on health outcomes.\n\n\nShow the code\nadmissions_plot &lt;- CAZ_admissions |&gt;\n  filter(Sex == \"Persons\") |&gt;\n  ggplot(aes(x = TimeperiodSortable, y = Value, col = AreaName)) +\n  scale_x_continuous(breaks = unique(CAZ_admissions$TimeperiodSortable)) +\n  geom_line() +\n  facet_grid(Age ~ ., scales = \"free_y\") +\n  theme_light() +\n  scale_color_discrete(type = \"qual\", palette = \"Dark2\") +\n  theme(axis.text.x = element_text(angle = 90)) +\n  labs(\n    title = \"Hospital Admissions for Under 19-years-olds\",\n    y = \"per 100,000\",\n    x = NULL\n  )\n\nggplotly(admissions_plot)",
    "crumbs": [
      "Analysis",
      "Under 19 yrs hospital admissions for asthma"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_practice_age_analysis.html",
    "href": "qmds_ghpages/CAZ_practice_age_analysis.html",
    "title": "Age groups and size of practice by boundary types",
    "section": "",
    "text": "TBC",
    "crumbs": [
      "Analysis",
      "Practice characteristics by CAZ boundaries"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_practice_age_analysis.html#overview",
    "href": "qmds_ghpages/CAZ_practice_age_analysis.html#overview",
    "title": "Age groups and size of practice by boundary types",
    "section": "",
    "text": "TBC",
    "crumbs": [
      "Analysis",
      "Practice characteristics by CAZ boundaries"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_practice_age_analysis.html#setup",
    "href": "qmds_ghpages/CAZ_practice_age_analysis.html#setup",
    "title": "Age groups and size of practice by boundary types",
    "section": "Setup",
    "text": "Setup\n\nPackage Installation\nLoading required packages for data analysis and visualisation.\n\n\nShow the code\noptions(repos = c(CRAN = \"https://cloud.r-project.org\"))\nif (!require(\"remotes\")) {\n  install.packages(\"remotes\")\n}\npkgs = c(\n  \"sf\",\n  \"tidyverse\",\n  \"here\",\n  \"tmap\",\n  \"data.table\"\n)\n\nremotes::install_cran(pkgs)\nsapply(pkgs, require, character.only = TRUE)\n\n\n        sf  tidyverse       here       tmap data.table \n      TRUE       TRUE       TRUE       TRUE       TRUE",
    "crumbs": [
      "Analysis",
      "Practice characteristics by CAZ boundaries"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_practice_age_analysis.html#loading-data",
    "href": "qmds_ghpages/CAZ_practice_age_analysis.html#loading-data",
    "title": "Age groups and size of practice by boundary types",
    "section": "Loading data",
    "text": "Loading data\n\nGP practices\nLoading spatial and administrative data for GP practices and CAZ areas.\n\n\nShow the code\nsubicb_boundaries &lt;- st_read(file.path(\n  here(),\n  \"data_raw\",\n  \"subicb_boundaries.gpkg\"\n))\n\n\nReading layer `subicb_boundaries' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\subicb_boundaries.gpkg' \n  using driver `GPKG'\nSimple feature collection with 106 features and 4 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 87318.43 ymin: 7053.782 xmax: 655646.4 ymax: 657547.7\nProjected CRS: OSGB36 / British National Grid\n\n\nShow the code\npract_classed &lt;- st_read(\"data_raw/CAZ_practices.gpkg\")\n\n\nReading layer `CAZ_practices' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\CAZ_practices.gpkg' \n  using driver `GPKG'\nSimple feature collection with 1362 features and 6 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 346814 ymin: 91824 xmax: 472242 ymax: 574443\nProjected CRS: OSGB36 / British National Grid\n\n\nShow the code\nall_practices &lt;- st_read(file.path(here(), \"data_raw\", \"gp_locations.gpkg\"))\n\n\nReading layer `gp_locations' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\gp_locations.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11968 features and 4 fields (with 7 geometries empty)\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 90774 ymin: 10282 xmax: 655043 ymax: 653236\nProjected CRS: OSGB36 / British National Grid\n\n\nShow the code\nCAZ_lst &lt;- read_csv(\"data_raw/CAZ_list.csv\")\n\n\n\n\nPatient data\nLoading patient registration data for calculating prescription rates.\n\n\nShow the code\npatient_age_df &lt;- read_csv(\"data_raw/practice_patients_age.csv\")\n\npatient_avg_age &lt;- as.data.table(patient_age_df)[,\n  `:=`(\n    lower = as.numeric(str_extract(AGE_GROUP, \"(?&lt;=(\\\\(|\\\\[))\\\\d{1,2}\")),\n    upper = as.numeric(str_extract(AGE_GROUP, \"\\\\d{2,3}(?=(\\\\)|\\\\]))\"))\n  )\n][,\n  midpoint := 0.5 * (lower + upper)\n][,\n  .(mean_age = weighted.mean(midpoint, NUMBER_OF_PATIENTS)),\n  by = .(ORG_CODE, month, year)\n][ORG_CODE %in% pract_classed$code]\n\npatient_avg_age$month &lt;- match(patient_avg_age$month, tolower(month.name))\n\n\n\n\nShow the code\npatient_num_df &lt;- as.data.table(patient_age_df)[,\n  .(NUMBER_OF_PATIENTS = sum(NUMBER_OF_PATIENTS)),\n  by = .(ORG_CODE, month, year)\n][ORG_CODE %in% pract_classed$code]",
    "crumbs": [
      "Analysis",
      "Practice characteristics by CAZ boundaries"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_practice_age_analysis.html#eda",
    "href": "qmds_ghpages/CAZ_practice_age_analysis.html#eda",
    "title": "Age groups and size of practice by boundary types",
    "section": "EDA",
    "text": "EDA\n\nAge distribution\nA quick exploration of the mean age of patients for different CAZ boundaries\n\n\nShow the code\ntmap_mode(\"view\")\n\npract_classed |&gt;\n  inner_join(\n    patient_avg_age |&gt;\n      filter(year == 2024, month == 12),\n    by = c(\"code\" = \"ORG_CODE\")\n  ) |&gt;\n  tm_shape() +\n  tm_dots(\"mean_age\")\n\n\n\n\n\n\n\n\n\nShow the code\npract_classed |&gt;\n  inner_join(\n    patient_avg_age |&gt;\n      filter(year == 2024, month == 12),\n    by = c(\"code\" = \"ORG_CODE\")\n  ) |&gt;\n  ggplot(aes(x = factor(buffer_km), y = mean_age)) +\n  geom_jitter(alpha = 0.2, col = \"dodgerblue\") +\n  geom_boxplot(outlier.shape = NA, varwidth = TRUE) +\n  facet_wrap(CAZ_name ~ .)\n\n\n\n\n\n\n\n\n\n\nVariations in mean_age\n\n\nShow the code\nvar_mean_age &lt;- patient_avg_age |&gt;\n  mutate(\n    ym = paste0(year, sprintf(\"%02d\", month)) |&gt; as.numeric(),\n    ym_date = ymd(paste0(ym, \"01\"))\n  ) |&gt;\n  mutate(baseline = if_else(ym == min(ym), mean_age, NA), .by = ORG_CODE) |&gt;\n  mutate(\n    baseline = if_else(is.na(baseline), sum(baseline, na.rm = TRUE), baseline),\n    .by = ORG_CODE\n  ) |&gt;\n  mutate(mean_age_std = mean_age - baseline)\n\n\nggplot(var_mean_age, aes(mean_age_std)) +\n  stat_ecdf() +\n  theme_minimal()\n\n\n\n\n\n\n\n\n\n\n\n\nSize distribution\n\n\nShow the code\nsf_practices_size &lt;- pract_classed |&gt;\n  left_join(\n    patient_num_df |&gt;\n      summarise(\n        across(NUMBER_OF_PATIENTS, \\(x) median(x, na.rm = T)),\n        .by = ORG_CODE\n      ),\n    by = c(\"code\" = \"ORG_CODE\")\n  )\n\n\n\n\nShow the code\nsf_practices_size |&gt;\n  ggplot(aes(x = factor(buffer_km), y = NUMBER_OF_PATIENTS)) +\n  geom_jitter(alpha = 0.2, col = \"dodgerblue\") +\n  geom_boxplot(outlier.shape = NA, varwidth = TRUE) +\n  scale_y_sqrt() +\n  facet_wrap(CAZ_name ~ .)\n\n\n\n\n\n\n\n\n\n\n\nVariation in size\n\n\nShow the code\npatient_num_df$month &lt;- match(patient_num_df$month, tolower(month.name))\n\nvar_size_pract &lt;- patient_num_df |&gt;\n\n  mutate(\n    ym = paste0(year, sprintf(\"%02d\", month)) |&gt; as.numeric(),\n    ym_date = ymd(paste0(ym, \"01\"))\n  ) |&gt;\n  mutate(\n    baseline = if_else(ym == min(ym), NUMBER_OF_PATIENTS, NA),\n    .by = ORG_CODE\n  ) |&gt;\n  mutate(\n    baseline = if_else(is.na(baseline), sum(baseline, na.rm = TRUE), baseline),\n    .by = ORG_CODE\n  ) |&gt;\n  mutate(patients_std = (NUMBER_OF_PATIENTS - baseline) / baseline)\n\n\nggplot(var_size_pract, aes(patients_std)) +\n  stat_ecdf() +\n  theme_minimal()",
    "crumbs": [
      "Analysis",
      "Practice characteristics by CAZ boundaries"
    ]
  },
  {
    "objectID": "qmds_ghpages/about.html",
    "href": "qmds_ghpages/about.html",
    "title": "About",
    "section": "",
    "text": "Place holder for the about section of this site",
    "crumbs": [
      "About"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_definition.html",
    "href": "qmds_ghpages/CAZ_definition.html",
    "title": "Clean Air Zones (CAZ)",
    "section": "",
    "text": "Clean Air Zones (CAZ) are designated areas within city centers where targeted action is taken to improve air quality by reducing the number of the most polluting vehicles. This section details the geographic boundaries of CAZ areas across the UK and provides access to the spatial data used in this analysis.\n\n\n\n\n\nLoading required R packages for spatial analysis and data manipulation.\n\n\nShow the code\noptions(repos = c(CRAN = \"https://cloud.r-project.org\"))\nif (!require(\"remotes\")) install.packages(\"remotes\")\npkgs = c(\n    \"sf\",\n    \"tidyverse\",\n    \"here\",\n    \"tmap\"\n)\n\nremotes::install_cran(pkgs)\nsapply(pkgs, require, character.only = TRUE)\n\n\n       sf tidyverse      here      tmap \n     TRUE      TRUE      TRUE      TRUE \n\n\n\n\n\n\n\n\nThe boundaries have been obtained manually from the different official repositories and compiled in a single gpkg file. The url to the sources is available in the metadata file.\nDownloading CAZ boundary spatial data if not already present locally.\n\n\nShow the code\ndir.create(\"data_raw\",showWarnings = F)\nif (!file.exists(\"data_raw/CAZ_boundaries.gpkg\")){\n  u &lt;- \"https://github.com/itsleeds/CAZ-health-data-trends/releases/download/v0/CAZ_boundaries.gpkg\"\n  f &lt;- basename(u)\n  download.file(u,destfile = file.path(\"data_raw\",f),mode = \"wb\",)\n}\n\n\n\n\n\nDownloading CAZ metadata including implementation dates and zone details.\n\n\nShow the code\nif (!file.exists(\"data_raw/CAZ_list.csv\")){\n  u &lt;- \"https://github.com/itsleeds/CAZ-health-data-trends/releases/download/v0/CAZ_list.csv\"\n  f &lt;- basename(u)\n  download.file(u,destfile = file.path(\"data_raw\",f),mode = \"wb\",)\n}\n\n\n\n\n\n\nLoading CAZ spatial boundaries and metadata into R for analysis.\n\n\nShow the code\ncaz_boundaries &lt;- st_read(file.path(here(),\"data_raw\",\"CAZ_boundaries.gpkg\"))\n\n\nReading layer `CAZ_boundaries' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\CAZ_boundaries.gpkg' \n  using driver `GPKG'\nSimple feature collection with 7 features and 1 field\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 356346.4 ymin: 99474.13 xmax: 465151.9 ymax: 565398\nProjected CRS: OSGB36 / British National Grid\n\n\nShow the code\ncaz_metadata &lt;- read_csv(file.path(here(),\"data_raw\",\"CAZ_list.csv\"))\n\n\n\n\n\nCreating buffer zones at different distances around CAZ boundaries for proximity analysis.\n\n\nShow the code\nbuffers &lt;- c(0,0.5,1,5,10)*1e3\n\ncaz_buffers &lt;- lapply(buffers, \\(buff_dist) {\n  st_buffer(caz_boundaries, dist = buff_dist) |&gt;\n    mutate(buffer_km = buff_dist / 1e3)\n}) |&gt;\n  bind_rows()\n\n\nSaving buffer zones to file for use in subsequent analyses.\n\n\nShow the code\nst_write(caz_buffers,file.path(here(),\"data_raw\",\"CAZ_buffers.gpkg\"),append = FALSE)\n\n\nDeleting layer `CAZ_buffers' using driver `GPKG'\nWriting layer `CAZ_buffers' to data source \n  `C:/temp_jf/CAZ-health-data-trends/data_raw/CAZ_buffers.gpkg' using driver `GPKG'\nWriting 35 features with 2 fields and geometry type Polygon.\n\n\nA quick visualisation\n\n\nShow the code\ntmap_mode(\"view\")\n\ntm_shape(caz_buffers |&gt; arrange(-buffer_km))+\n  tm_polygons(\"buffer_km\",\n              fill_alpha = 0.4,\n              fill.scale = tm_scale_discrete(ticks = buffers/1e3,\n                                             values = \"-brewer.blues\")\n              )",
    "crumbs": [
      "Data",
      "Clean Air Zones"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_definition.html#overview",
    "href": "qmds_ghpages/CAZ_definition.html#overview",
    "title": "Clean Air Zones (CAZ)",
    "section": "",
    "text": "Clean Air Zones (CAZ) are designated areas within city centers where targeted action is taken to improve air quality by reducing the number of the most polluting vehicles. This section details the geographic boundaries of CAZ areas across the UK and provides access to the spatial data used in this analysis.",
    "crumbs": [
      "Data",
      "Clean Air Zones"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_definition.html#setup",
    "href": "qmds_ghpages/CAZ_definition.html#setup",
    "title": "Clean Air Zones (CAZ)",
    "section": "",
    "text": "Loading required R packages for spatial analysis and data manipulation.\n\n\nShow the code\noptions(repos = c(CRAN = \"https://cloud.r-project.org\"))\nif (!require(\"remotes\")) install.packages(\"remotes\")\npkgs = c(\n    \"sf\",\n    \"tidyverse\",\n    \"here\",\n    \"tmap\"\n)\n\nremotes::install_cran(pkgs)\nsapply(pkgs, require, character.only = TRUE)\n\n\n       sf tidyverse      here      tmap \n     TRUE      TRUE      TRUE      TRUE",
    "crumbs": [
      "Data",
      "Clean Air Zones"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_definition.html#downloading-data",
    "href": "qmds_ghpages/CAZ_definition.html#downloading-data",
    "title": "Clean Air Zones (CAZ)",
    "section": "",
    "text": "The boundaries have been obtained manually from the different official repositories and compiled in a single gpkg file. The url to the sources is available in the metadata file.\nDownloading CAZ boundary spatial data if not already present locally.\n\n\nShow the code\ndir.create(\"data_raw\",showWarnings = F)\nif (!file.exists(\"data_raw/CAZ_boundaries.gpkg\")){\n  u &lt;- \"https://github.com/itsleeds/CAZ-health-data-trends/releases/download/v0/CAZ_boundaries.gpkg\"\n  f &lt;- basename(u)\n  download.file(u,destfile = file.path(\"data_raw\",f),mode = \"wb\",)\n}\n\n\n\n\n\nDownloading CAZ metadata including implementation dates and zone details.\n\n\nShow the code\nif (!file.exists(\"data_raw/CAZ_list.csv\")){\n  u &lt;- \"https://github.com/itsleeds/CAZ-health-data-trends/releases/download/v0/CAZ_list.csv\"\n  f &lt;- basename(u)\n  download.file(u,destfile = file.path(\"data_raw\",f),mode = \"wb\",)\n}",
    "crumbs": [
      "Data",
      "Clean Air Zones"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_definition.html#loading-data",
    "href": "qmds_ghpages/CAZ_definition.html#loading-data",
    "title": "Clean Air Zones (CAZ)",
    "section": "",
    "text": "Loading CAZ spatial boundaries and metadata into R for analysis.\n\n\nShow the code\ncaz_boundaries &lt;- st_read(file.path(here(),\"data_raw\",\"CAZ_boundaries.gpkg\"))\n\n\nReading layer `CAZ_boundaries' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\CAZ_boundaries.gpkg' \n  using driver `GPKG'\nSimple feature collection with 7 features and 1 field\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 356346.4 ymin: 99474.13 xmax: 465151.9 ymax: 565398\nProjected CRS: OSGB36 / British National Grid\n\n\nShow the code\ncaz_metadata &lt;- read_csv(file.path(here(),\"data_raw\",\"CAZ_list.csv\"))",
    "crumbs": [
      "Data",
      "Clean Air Zones"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_definition.html#processing-buffers",
    "href": "qmds_ghpages/CAZ_definition.html#processing-buffers",
    "title": "Clean Air Zones (CAZ)",
    "section": "",
    "text": "Creating buffer zones at different distances around CAZ boundaries for proximity analysis.\n\n\nShow the code\nbuffers &lt;- c(0,0.5,1,5,10)*1e3\n\ncaz_buffers &lt;- lapply(buffers, \\(buff_dist) {\n  st_buffer(caz_boundaries, dist = buff_dist) |&gt;\n    mutate(buffer_km = buff_dist / 1e3)\n}) |&gt;\n  bind_rows()\n\n\nSaving buffer zones to file for use in subsequent analyses.\n\n\nShow the code\nst_write(caz_buffers,file.path(here(),\"data_raw\",\"CAZ_buffers.gpkg\"),append = FALSE)\n\n\nDeleting layer `CAZ_buffers' using driver `GPKG'\nWriting layer `CAZ_buffers' to data source \n  `C:/temp_jf/CAZ-health-data-trends/data_raw/CAZ_buffers.gpkg' using driver `GPKG'\nWriting 35 features with 2 fields and geometry type Polygon.\n\n\nA quick visualisation\n\n\nShow the code\ntmap_mode(\"view\")\n\ntm_shape(caz_buffers |&gt; arrange(-buffer_km))+\n  tm_polygons(\"buffer_km\",\n              fill_alpha = 0.4,\n              fill.scale = tm_scale_discrete(ticks = buffers/1e3,\n                                             values = \"-brewer.blues\")\n              )",
    "crumbs": [
      "Data",
      "Clean Air Zones"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_prescription_trends.html",
    "href": "qmds_ghpages/CAZ_prescription_trends.html",
    "title": "CAZ_prescription_trends",
    "section": "",
    "text": "This section presents a comprehensive analysis of prescription trends in areas affected by Clean Air Zones (CAZ). The analysis focuses primarily on Short-Acting Beta Agonists (SABA) inhalers, which are commonly prescribed for asthma and other respiratory conditions.\nBy examining prescription patterns before and after CAZ implementation, and comparing areas within CAZ boundaries to surrounding areas, we can assess whether air quality improvements are associated with changes in respiratory medication use. A reduction in SABA prescriptions could indicate improved respiratory health outcomes in the population.\nThe analysis incorporates:\n\nTemporal trends: Changes in prescription rates over time\nSpatial patterns: Differences between CAZ and non-CAZ areas\nPractice-level analysis: Variations across individual GP practices\nPopulation adjustments: Accounting for patient registration numbers\n\nThis comprehensive approach helps to identify potential causal relationships between air quality interventions and health outcomes while controlling for confounding factors.",
    "crumbs": [
      "Analysis",
      "Trends by practice location"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_prescription_trends.html#overview",
    "href": "qmds_ghpages/CAZ_prescription_trends.html#overview",
    "title": "CAZ_prescription_trends",
    "section": "",
    "text": "This section presents a comprehensive analysis of prescription trends in areas affected by Clean Air Zones (CAZ). The analysis focuses primarily on Short-Acting Beta Agonists (SABA) inhalers, which are commonly prescribed for asthma and other respiratory conditions.\nBy examining prescription patterns before and after CAZ implementation, and comparing areas within CAZ boundaries to surrounding areas, we can assess whether air quality improvements are associated with changes in respiratory medication use. A reduction in SABA prescriptions could indicate improved respiratory health outcomes in the population.\nThe analysis incorporates:\n\nTemporal trends: Changes in prescription rates over time\nSpatial patterns: Differences between CAZ and non-CAZ areas\nPractice-level analysis: Variations across individual GP practices\nPopulation adjustments: Accounting for patient registration numbers\n\nThis comprehensive approach helps to identify potential causal relationships between air quality interventions and health outcomes while controlling for confounding factors.",
    "crumbs": [
      "Analysis",
      "Trends by practice location"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_prescription_trends.html#setup",
    "href": "qmds_ghpages/CAZ_prescription_trends.html#setup",
    "title": "CAZ_prescription_trends",
    "section": "Setup",
    "text": "Setup\n\nPackage Installation\nLoading required packages for data analysis and visualisation.\n\n\nShow the code\noptions(repos = c(CRAN = \"https://cloud.r-project.org\"))\nif (!require(\"remotes\")) {\n  install.packages(\"remotes\")\n}\npkgs = c(\n  \"sf\",\n  \"tidyverse\",\n  \"here\",\n  \"tmap\",\n  \"data.table\"\n)\n\nremotes::install_cran(pkgs)\nsapply(pkgs, require, character.only = TRUE)\n\n\n        sf  tidyverse       here       tmap data.table \n      TRUE       TRUE       TRUE       TRUE       TRUE",
    "crumbs": [
      "Analysis",
      "Trends by practice location"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_prescription_trends.html#loading-data",
    "href": "qmds_ghpages/CAZ_prescription_trends.html#loading-data",
    "title": "CAZ_prescription_trends",
    "section": "Loading data",
    "text": "Loading data\n\nGP practices\nLoading spatial and administrative data for GP practices and CAZ areas.\n\n\nShow the code\nsubicb_boundaries &lt;- st_read(file.path(\n  here(),\n  \"data_raw\",\n  \"subicb_boundaries.gpkg\"\n))\n\n\nReading layer `subicb_boundaries' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\subicb_boundaries.gpkg' \n  using driver `GPKG'\nSimple feature collection with 106 features and 4 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 87318.43 ymin: 7053.782 xmax: 655646.4 ymax: 657547.7\nProjected CRS: OSGB36 / British National Grid\n\n\nShow the code\npract_classed &lt;- st_read(\"data_raw/CAZ_practices.gpkg\")\n\n\nReading layer `CAZ_practices' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\CAZ_practices.gpkg' \n  using driver `GPKG'\nSimple feature collection with 1362 features and 6 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 346814 ymin: 91824 xmax: 472242 ymax: 574443\nProjected CRS: OSGB36 / British National Grid\n\n\nShow the code\nall_practices &lt;- st_read(file.path(here(), \"data_raw\", \"gp_locations.gpkg\"))\n\n\nReading layer `gp_locations' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\gp_locations.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11968 features and 4 fields (with 7 geometries empty)\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 90774 ymin: 10282 xmax: 655043 ymax: 653236\nProjected CRS: OSGB36 / British National Grid\n\n\nShow the code\nCAZ_lst &lt;- read_csv(\"data_raw/CAZ_list.csv\")\n\n\n\n\nPatient data\nLoading patient registration data for calculating prescription rates.\n\n\nShow the code\npatient_num_df &lt;- read_csv(\"data_raw/practice_patients.csv\")\n\npatient_num_df$month &lt;- match(patient_num_df$month, tolower(month.name))\n\n\n\n\nPrescription data\nLoading SABA prescription data for respiratory health analysis.\n\n\nShow the code\nall_saba_raw &lt;- read_csv(file = file.path(here(), \"data_raw\", \"all_saba.csv\"))\n\n\nLoading comprehensive BNF prescription data for broader medication analysis.\n\n\nShow the code\nget_all_data &lt;- function(group) {\n  lst_files &lt;- list.files(\n    \"data_raw/bnf_all/\",\n    pattern = paste0(\"^\\\\d{\", group, \"}_\\\\d{4}\"),\n    full.names = TRUE\n  )\n  lapply(\n    lst_files,\n    \\(i) {\n      fread(i)[,\n        bnf := str_extract(\n          pattern = paste0(\"^\\\\d{\", group, \"}\"),\n          string = basename(i)\n        )\n      ]\n    }\n  ) |&gt;\n    rbindlist()\n}\n\nall_data &lt;- get_all_data(2)\n\n\nLoading data for Montelukast\n\n\nShow the code\nget_code_data &lt;- function(code) {\n  lst_files &lt;- list.files(\n    \"data_raw/bnf_all/\",\n    pattern = code,\n    full.names = TRUE\n  )\n  lapply(\n    lst_files,\n    \\(i) {\n      fread(i)[, bnf := str_extract(pattern = code, string = basename(i))]\n    }\n  ) |&gt;\n    rbindlist()\n}\n\nall_mtlkt_data &lt;- get_code_data(code = \"0303020G0\")",
    "crumbs": [
      "Analysis",
      "Trends by practice location"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_prescription_trends.html#preparing-data",
    "href": "qmds_ghpages/CAZ_prescription_trends.html#preparing-data",
    "title": "CAZ_prescription_trends",
    "section": "Preparing data",
    "text": "Preparing data\n\nClassifying practices between CAZ and non-CAZ (except London)\nCreating location-based classifications for GP practices relative to CAZ boundaries.\n\n\nShow the code\nCAZ_practices &lt;- pract_classed |&gt;\n  mutate(\n    location_class = case_when(\n      buffer_km == 0 ~ \"within CAZ\",\n      buffer_km &lt;= 1 ~ \"within 1km\",\n      buffer_km &lt;= 5 ~ \"within 5km\",\n      TRUE ~ \"out CAZ\"\n    )\n  ) |&gt;\n  mutate(\n    location_class = factor(\n      location_class,\n      levels = c(\n        \"within CAZ\",\n        \"within 1km\",\n        \"within 5km\",\n        \"out CAZ\",\n        \"Control\"\n      ),\n      ordered = T\n    )\n  )\n\nall_valid_subicb_codes &lt;- subicb_boundaries |&gt;\n  st_drop_geometry() |&gt;\n  filter(str_detect(name, \"LONDON\", negate = TRUE)) |&gt;\n  pull(code)\n\n\nall_other_codes &lt;- all_practices |&gt;\n  st_drop_geometry() |&gt;\n  filter(!(par_code %in% all_valid_subicb_codes)) |&gt;\n  pull(code)\n\n\n\n\nSubsetting SABA data\nFiltering SABA prescription data for CAZ and control areas with patient population adjustments.\n\n\nShow the code\nCAZ_SABA &lt;- all_saba_raw |&gt;\n  filter(org_id %in% CAZ_practices$code) |&gt;\n  mutate(month = month(date), year = year(date)) |&gt;\n  left_join(\n    patient_num_df |&gt; select(CODE, NUMBER_OF_PATIENTS, month, year),\n    by = c(\"org_id\" = \"CODE\", \"month\", \"year\")\n  )\n\n\nnoCAZ_SABA &lt;- all_saba_raw |&gt;\n  filter(!org_id %in% CAZ_practices$code, org_id %in% all_other_codes) |&gt;\n  mutate(month = month(date), year = year(date)) |&gt;\n  left_join(patient_num_df, by = c(\"org_id\" = \"CODE\", \"month\", \"year\")) |&gt;\n  mutate(location_class = \"Control\") |&gt;\n  mutate(\n    location_class = factor(\n      location_class,\n      levels = c(\n        \"within CAZ\",\n        \"within 1km\",\n        \"within 5km\",\n        \"out CAZ\",\n        \"Control\"\n      ),\n      ordered = T\n    )\n  )\n\n\n\n\nSubsetting data of main BNF codes\nFiltering broader BNF prescription data for comprehensive medication analysis.\n\n\nShow the code\nCAZ_bnf &lt;- all_data[row_id %in% CAZ_practices$code, ][, `:=`(\n  month = month(date),\n  year = year(date)\n)] |&gt;\n  left_join(\n    patient_num_df |&gt; select(CODE, NUMBER_OF_PATIENTS, month, year),\n    by = c(\"row_id\" = \"CODE\", \"month\", \"year\")\n  )\n\nnoCAZ_bnf &lt;- all_data[\n  !row_id %in% CAZ_practices$code & row_id %in% all_other_codes,\n][, `:=`(month = month(date), year = year(date))] |&gt;\n  left_join(\n    patient_num_df |&gt; select(CODE, NUMBER_OF_PATIENTS, month, year),\n    by = c(\"row_id\" = \"CODE\", \"month\", \"year\")\n  ) |&gt;\n  mutate(location_class = \"Control\") |&gt;\n  mutate(\n    location_class = factor(\n      location_class,\n      levels = c(\n        \"within CAZ\",\n        \"within 1km\",\n        \"within 5km\",\n        \"out CAZ\",\n        \"Control\"\n      ),\n      ordered = T\n    )\n  )\n\n\n\n\nSubsetting data of Montelukast\n\n\nShow the code\nCAZ_mtlkst &lt;- all_mtlkt_data[row_id %in% CAZ_practices$code, ][, `:=`(\n  month = month(date),\n  year = year(date)\n)] |&gt;\n  left_join(\n    patient_num_df |&gt; select(CODE, NUMBER_OF_PATIENTS, month, year),\n    by = c(\"row_id\" = \"CODE\", \"month\", \"year\")\n  )\n\nnoCAZ_mtlkst &lt;- all_mtlkt_data[\n  !row_id %in% CAZ_practices$code & row_id %in% all_other_codes,\n][, `:=`(month = month(date), year = year(date))] |&gt;\n  left_join(\n    patient_num_df |&gt; select(CODE, NUMBER_OF_PATIENTS, month, year),\n    by = c(\"row_id\" = \"CODE\", \"month\", \"year\")\n  ) |&gt;\n  mutate(location_class = \"Control\") |&gt;\n  mutate(\n    location_class = factor(\n      location_class,\n      levels = c(\n        \"within CAZ\",\n        \"within 1km\",\n        \"within 5km\",\n        \"out CAZ\",\n        \"Control\"\n      ),\n      ordered = T\n    )\n  )",
    "crumbs": [
      "Analysis",
      "Trends by practice location"
    ]
  },
  {
    "objectID": "qmds_ghpages/CAZ_prescription_trends.html#extracting-trends",
    "href": "qmds_ghpages/CAZ_prescription_trends.html#extracting-trends",
    "title": "CAZ_prescription_trends",
    "section": "Extracting trends",
    "text": "Extracting trends\n\nSABA\nAggregating SABA prescription data for control areas (excluding London).\n\n\nShow the code\nnoCAZ_SABA_aggre &lt;- noCAZ_SABA |&gt;\n  summarise(\n    across(c(NUMBER_OF_PATIENTS, numerator, denominator), \\(x) {\n      sum(x, na.rm = T)\n    }),\n    .by = c(location_class, month, year, date)\n  ) |&gt;\n  mutate(calc_value = numerator / denominator)\n\n\n\nSABA ratio\n\n\nShow the code\nplots_SABA_ratio &lt;- CAZ_SABA |&gt;\n  left_join(\n    CAZ_practices |&gt;\n      st_drop_geometry() |&gt;\n      select(code, location_class, CAZ_name),\n    by = c(\"org_id\" = \"code\")\n  ) |&gt;\n\n  summarise(\n    across(c(NUMBER_OF_PATIENTS, numerator, denominator), \\(x) {\n      sum(x, na.rm = T)\n    }),\n    .by = c(location_class, CAZ_name, month, year, date)\n  ) |&gt;\n  mutate(calc_value = numerator / denominator) |&gt;\n  nest(.by = c(CAZ_name)) |&gt;\n  left_join(CAZ_lst |&gt; select(CAZ, Start), by = c(\"CAZ_name\" = \"CAZ\")) |&gt;\n  mutate(\n    trend_data = map2(data, Start, \\(.x, .y) {\n      .x |&gt;\n        bind_rows(noCAZ_SABA_aggre) |&gt;\n        filter(year &gt;= .y)\n    })\n  ) |&gt;\n  mutate(\n    plots = map2(data, trend_data, \\(.x, .y) {\n      .x |&gt;\n        ggplot(aes(x = date, y = calc_value, colour = location_class)) +\n        geom_line(aes(group = location_class), alpha = 0.2, linewidth = 0.2) +\n        geom_smooth(\n          data = .y,\n          method = \"lm\",\n          formula = 'y ~ x',\n          se = F,\n          aes(linetype = location_class)\n        ) +\n        theme_minimal() +\n        scale_colour_manual(\n          values = c(cols4all::c4a(palette = \"set1\")[1:4], \"gray30\")\n        ) +\n        scale_y_continuous(limits = c(0, 0.7)) +\n        scale_linetype_manual(values = c(rep(\"solid\", 4), \"dashed\")) +\n        guides(linetype = \"none\")\n    }),\n    plots = map2(plots, CAZ_name, \\(.x, .y) {\n      .x + labs(title = .y, y = \"SABA ratio\", col = \"Location Class\", x = \"\")\n    })\n  )\n\n\n\n\nShow the code\nfor (i in plots_SABA_ratio$plots) {\n  print(i)\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nSABA numerator\n\n\nShow the code\nplots_SABA_numerator &lt;- CAZ_SABA |&gt;\n  left_join(\n    CAZ_practices |&gt;\n      st_drop_geometry() |&gt;\n      select(code, location_class, CAZ_name),\n    by = c(\"org_id\" = \"code\")\n  ) |&gt;\n\n  summarise(\n    across(c(NUMBER_OF_PATIENTS, numerator, denominator), \\(x) {\n      sum(x, na.rm = T)\n    }),\n    .by = c(location_class, CAZ_name, month, year, date)\n  ) |&gt;\n  mutate(calc_value = numerator / denominator) |&gt;\n  nest(.by = c(CAZ_name)) |&gt;\n  left_join(CAZ_lst |&gt; select(CAZ, Start), by = c(\"CAZ_name\" = \"CAZ\")) |&gt;\n  mutate(\n    trend_data = map2(data, Start, \\(.x, .y) {\n      .x |&gt;\n        bind_rows(noCAZ_SABA_aggre) |&gt;\n        filter(year &gt;= .y)\n    })\n  ) |&gt;\n  mutate(\n    plots = map2(data, trend_data, \\(.x, .y) {\n      .x |&gt;\n        ggplot(aes(\n          x = date,\n          y = numerator / NUMBER_OF_PATIENTS,\n          colour = location_class\n        )) +\n        geom_line(aes(group = location_class), alpha = 0.2, linewidth = 0.2) +\n        geom_smooth(\n          data = .y,\n          method = \"lm\",\n          formula = 'y ~ x',\n          se = F,\n          aes(linetype = location_class)\n        ) +\n        theme_minimal() +\n        scale_colour_manual(\n          values = c(cols4all::c4a(palette = \"set1\")[1:4], \"gray30\")\n        ) +\n        # scale_y_continuous(limits = c(0,1))+\n        scale_linetype_manual(values = c(rep(\"solid\", 4), \"dashed\")) +\n        guides(linetype = \"none\")\n    }),\n    plots = map2(plots, CAZ_name, \\(.x, .y) {\n      .x +\n        labs(\n          title = .y,\n          y = \"Prescriptions of SABA inhalers per patient\",\n          col = \"Location Class\",\n          x = \"\"\n        )\n    })\n  )\n\n\n\n\nShow the code\nfor (i in plots_SABA_numerator$plots) {\n  print(i)\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nSABA denominator (all inhalers)\n\n\nShow the code\nplots_SABA_denominator &lt;- CAZ_SABA |&gt;\n  left_join(\n    CAZ_practices |&gt;\n      st_drop_geometry() |&gt;\n      select(code, location_class, CAZ_name),\n    by = c(\"org_id\" = \"code\")\n  ) |&gt;\n\n  summarise(\n    across(c(NUMBER_OF_PATIENTS, numerator, denominator), \\(x) {\n      sum(x, na.rm = T)\n    }),\n    .by = c(location_class, CAZ_name, month, year, date)\n  ) |&gt;\n  mutate(calc_value = numerator / denominator) |&gt;\n  nest(.by = c(CAZ_name)) |&gt;\n  left_join(CAZ_lst |&gt; select(CAZ, Start), by = c(\"CAZ_name\" = \"CAZ\")) |&gt;\n  mutate(\n    trend_data = map2(data, Start, \\(.x, .y) {\n      .x |&gt;\n        bind_rows(noCAZ_SABA_aggre) |&gt;\n        filter(year &gt;= .y)\n    })\n  ) |&gt;\n  mutate(\n    plots = map2(data, trend_data, \\(.x, .y) {\n      .x |&gt;\n        ggplot(aes(\n          x = date,\n          y = denominator / NUMBER_OF_PATIENTS,\n          colour = location_class\n        )) +\n        geom_line(aes(group = location_class), alpha = 0.2, linewidth = 0.2) +\n        geom_smooth(\n          data = .y,\n          method = \"lm\",\n          formula = 'y ~ x',\n          se = F,\n          aes(linetype = location_class)\n        ) +\n        theme_minimal() +\n        scale_colour_manual(\n          values = c(cols4all::c4a(palette = \"set1\")[1:4], \"gray30\")\n        ) +\n        # scale_y_continuous(limits = c(0,1))+\n        scale_linetype_manual(values = c(rep(\"solid\", 4), \"dashed\")) +\n        guides(linetype = \"none\")\n    }),\n    plots = map2(plots, CAZ_name, \\(.x, .y) {\n      .x +\n        labs(\n          title = .y,\n          y = \"Prescriptions inhalers per patient\",\n          col = \"Location Class\",\n          x = \"\"\n        )\n    })\n  )\n\n\n\n\nShow the code\nfor (i in plots_SABA_denominator$plots) {\n  print(i)\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nMontelukast prescriptions\nProcessing data\n\n\nShow the code\nnoCAZ_mtlkst_aggre &lt;- noCAZ_mtlkst |&gt;\n  summarise(\n    across(c(NUMBER_OF_PATIENTS, items, quantity), \\(x) sum(x, na.rm = T)),\n    .by = c(location_class, month, year, date, bnf)\n  )\nnoCAZ_mtlkst_aggre$date &lt;- as.Date(noCAZ_mtlkst_aggre$date)\nCAZ_mtlkst$date &lt;- as.Date(CAZ_mtlkst$date)\n\nnoCAZ_mtlkst_nest &lt;- noCAZ_mtlkst_aggre |&gt;\n  nest(.by = bnf, .key = \"control_data\")\n\n\n\nVisualisations\nPreparing plots\n\n\nShow the code\nplots_mtlkst &lt;- CAZ_mtlkst |&gt;\n  left_join(\n    CAZ_practices |&gt;\n      st_drop_geometry() |&gt;\n      select(code, location_class, CAZ_name),\n    by = c(\"row_id\" = \"code\")\n  ) |&gt;\n  summarise(\n    across(c(NUMBER_OF_PATIENTS, items, quantity), \\(x) sum(x, na.rm = T)),\n    .by = c(location_class, CAZ_name, month, year, date, bnf)\n  ) |&gt;\n  nest(.by = c(CAZ_name, bnf)) |&gt;\n  left_join(\n    CAZ_lst |&gt;\n      select(CAZ, Start),\n    by = c(\"CAZ_name\" = \"CAZ\")\n  ) |&gt;\n  left_join(noCAZ_mtlkst_nest, by = \"bnf\") |&gt;\n  mutate(\n    trend_data = map2(data, Start, \\(.x, .y) {\n      .x |&gt;\n        filter(year &gt;= .y)\n    }),\n    trend_data = map2(trend_data, control_data, \\(.x, .y) {\n      .x |&gt;\n        bind_rows(\n          .y |&gt;\n            filter(year &gt;= min(.x$year))\n        )\n    })\n  ) |&gt;\n  mutate(\n    plots = map2(data, trend_data, \\(.x, .y) {\n      .x |&gt;\n        ggplot(aes(\n          x = date,\n          y = items / NUMBER_OF_PATIENTS,\n          colour = location_class\n        )) +\n        geom_line(aes(group = location_class), alpha = 0.2, linewidth = 0.2) +\n        geom_smooth(\n          data = .y,\n          method = \"lm\",\n          formula = 'y ~ x',\n          se = F,\n          aes(linetype = location_class)\n        ) +\n        theme_minimal() +\n        scale_colour_manual(\n          values = c(cols4all::c4a(palette = \"set1\")[1:4], \"gray30\")\n        ) +\n        # scale_y_continuous(limits = c(0,0.7))+\n        scale_linetype_manual(values = c(rep(\"solid\", 4), \"dashed\")) +\n        guides(linetype = \"none\")\n    }),\n    plots = map2(plots, CAZ_name, \\(.x, .y) {\n      .x +\n        labs(\n          title = .y,\n          y = \"Items per patient\",\n          col = \"Location Class\",\n          x = \"\"\n        )\n    }),\n    plots = map2(plots, bnf, \\(.x, .y) {\n      .x + labs(subtitle = paste(\"BNF code:\", .y))\n    })\n  )\n\n\n\nBNF code: 0303020G0\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \naa\n\n\n\n\n\nMain BNF codes\nThis analysis is undertaken for all the main BNF codes, see this\nCalculating trends from all other practices (except London) as a control\n\n\nShow the code\nnoCAZ_bnf_aggre &lt;- noCAZ_bnf |&gt;\n  summarise(\n    across(c(NUMBER_OF_PATIENTS, items, quantity), \\(x) sum(x, na.rm = T)),\n    .by = c(location_class, month, year, date, bnf)\n  )\nnoCAZ_bnf_aggre$date &lt;- as.Date(noCAZ_bnf_aggre$date)\nCAZ_bnf$date &lt;- as.Date(CAZ_bnf$date)\n\nnoCAZ_bnf_nest &lt;- noCAZ_bnf_aggre |&gt;\n  nest(.by = bnf, .key = \"control_data\")\n\n\n\nVisualisations\n\n\nShow the code\nplots_bnf &lt;- CAZ_bnf |&gt;\n  left_join(\n    CAZ_practices |&gt;\n      st_drop_geometry() |&gt;\n      select(code, location_class, CAZ_name),\n    by = c(\"row_id\" = \"code\")\n  ) |&gt;\n\n  summarise(\n    across(c(NUMBER_OF_PATIENTS, items, quantity), \\(x) sum(x, na.rm = T)),\n    .by = c(location_class, CAZ_name, month, year, date, bnf)\n  ) |&gt;\n  nest(.by = c(CAZ_name, bnf)) |&gt;\n  left_join(\n    CAZ_lst |&gt;\n      select(CAZ, Start),\n    by = c(\"CAZ_name\" = \"CAZ\")\n  ) |&gt;\n  left_join(noCAZ_bnf_nest, by = \"bnf\") |&gt;\n  mutate(\n    trend_data = map2(data, Start, \\(.x, .y) {\n      .x |&gt;\n        filter(year &gt;= .y)\n    }),\n    trend_data = map2(trend_data, control_data, \\(.x, .y) {\n      .x |&gt;\n        bind_rows(\n          .y |&gt;\n            filter(year &gt;= min(.x$year))\n        )\n    })\n  ) |&gt;\n  mutate(\n    plots = map2(data, trend_data, \\(.x, .y) {\n      .x |&gt;\n        ggplot(aes(\n          x = date,\n          y = items / NUMBER_OF_PATIENTS,\n          colour = location_class\n        )) +\n        geom_line(aes(group = location_class), alpha = 0.2, linewidth = 0.2) +\n        geom_smooth(\n          data = .y,\n          method = \"lm\",\n          formula = 'y ~ x',\n          se = F,\n          aes(linetype = location_class)\n        ) +\n        theme_minimal() +\n        scale_colour_manual(\n          values = c(cols4all::c4a(palette = \"set1\")[1:4], \"gray30\")\n        ) +\n        # scale_y_continuous(limits = c(0,0.7))+\n        scale_linetype_manual(values = c(rep(\"solid\", 4), \"dashed\")) +\n        guides(linetype = \"none\")\n    }),\n    plots = map2(plots, CAZ_name, \\(.x, .y) {\n      .x +\n        labs(\n          title = .y,\n          y = \"Items per patient\",\n          col = \"Location Class\",\n          x = \"\"\n        )\n    }),\n    plots = map2(plots, bnf, \\(.x, .y) {\n      .x + labs(subtitle = paste(\"BNF code:\", .y))\n    })\n  )\n\n\n\nBNF code: 01\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 02\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 03\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 04\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 05\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 06\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 07\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 08\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 09\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 10\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 11\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 12\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 13\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 14\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 15\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 18\n\nCAZ: Newcastle upon Tyne\nlist()\n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\nlist()\n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\nlist()\n\n\nCAZ: Bristol\nlist()\n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 19\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 20\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 21\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 22\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]] \n\n\n\nBNF code: 23\n\nCAZ: Newcastle upon Tyne\n[[1]] \n\n\nCAZ: Bradford\n[[1]] \n\n\nCAZ: Sheffield\n[[1]] \n\n\nCAZ: Portsmouth\n[[1]] \n\n\nCAZ: BANES\n[[1]] \n\n\nCAZ: Bristol\n[[1]] \n\n\nCAZ: Birmingham\n[[1]]",
    "crumbs": [
      "Analysis",
      "Trends by practice location"
    ]
  },
  {
    "objectID": "qmds_ghpages/fingertips_data.html",
    "href": "qmds_ghpages/fingertips_data.html",
    "title": "fingertips_data",
    "section": "",
    "text": "This section accesses and analyses public health data from NHS Digital’s Fingertips platform. Fingertips provides a comprehensive collection of health indicators at various geographic levels, making it an invaluable resource for understanding population health patterns.\nFor this CAZ health analysis, we focus particularly on respiratory health indicators including:\n\nAsthma prevalence: Recorded prevalence of asthma in different age groups\nHospital admissions: Emergency admissions for respiratory conditions\nAir quality measures: Local pollution levels and monitoring data\nMortality indicators: Deaths attributable to respiratory diseases\n\nThe Fingertips API allows us to access standardized health indicators that can be compared across different geographic areas and time periods. This provides important contextual information for understanding the baseline health status of populations in CAZ areas compared to control areas.\nBy combining Fingertips data with our prescription analysis, we can build a more complete picture of respiratory health trends and validate our findings against established public health surveillance systems.\n\n\nShow the code\noptions(repos = c(CRAN = \"https://cloud.r-project.org\"))\nif (!require(\"remotes\")) {\n  install.packages(\"remotes\")\n}\npkgs = c(\n  \"sf\",\n  \"tidyverse\",\n  \"here\",\n  \"tmap\"\n)\n\nremotes::install_cran(pkgs)\nsapply(pkgs, require, character.only = TRUE)\n\n\n       sf tidyverse      here      tmap \n     TRUE      TRUE      TRUE      TRUE \n\n\nShow the code\nif (!(\"fingertipsR\" %in% installed.packages())) {\n  remotes::install_github(\n    \"rOpenSci/fingertipsR\",\n    build_vignettes = TRUE,\n    quiet = TRUE\n  )\n}\n\nlibrary(fingertipsR)",
    "crumbs": [
      "Data",
      "Health indicators"
    ]
  },
  {
    "objectID": "qmds_ghpages/fingertips_data.html#overview",
    "href": "qmds_ghpages/fingertips_data.html#overview",
    "title": "fingertips_data",
    "section": "",
    "text": "This section accesses and analyses public health data from NHS Digital’s Fingertips platform. Fingertips provides a comprehensive collection of health indicators at various geographic levels, making it an invaluable resource for understanding population health patterns.\nFor this CAZ health analysis, we focus particularly on respiratory health indicators including:\n\nAsthma prevalence: Recorded prevalence of asthma in different age groups\nHospital admissions: Emergency admissions for respiratory conditions\nAir quality measures: Local pollution levels and monitoring data\nMortality indicators: Deaths attributable to respiratory diseases\n\nThe Fingertips API allows us to access standardized health indicators that can be compared across different geographic areas and time periods. This provides important contextual information for understanding the baseline health status of populations in CAZ areas compared to control areas.\nBy combining Fingertips data with our prescription analysis, we can build a more complete picture of respiratory health trends and validate our findings against established public health surveillance systems.\n\n\nShow the code\noptions(repos = c(CRAN = \"https://cloud.r-project.org\"))\nif (!require(\"remotes\")) {\n  install.packages(\"remotes\")\n}\npkgs = c(\n  \"sf\",\n  \"tidyverse\",\n  \"here\",\n  \"tmap\"\n)\n\nremotes::install_cran(pkgs)\nsapply(pkgs, require, character.only = TRUE)\n\n\n       sf tidyverse      here      tmap \n     TRUE      TRUE      TRUE      TRUE \n\n\nShow the code\nif (!(\"fingertipsR\" %in% installed.packages())) {\n  remotes::install_github(\n    \"rOpenSci/fingertipsR\",\n    build_vignettes = TRUE,\n    quiet = TRUE\n  )\n}\n\nlibrary(fingertipsR)",
    "crumbs": [
      "Data",
      "Health indicators"
    ]
  },
  {
    "objectID": "qmds_ghpages/fingertips_data.html#data-acquisition",
    "href": "qmds_ghpages/fingertips_data.html#data-acquisition",
    "title": "fingertips_data",
    "section": "Data Acquisition",
    "text": "Data Acquisition\n\nProfile Discovery\nRetrieving the complete list of available health data profiles from the Fingertips platform.\n\n\nShow the code\nprofile_lst &lt;- profiles()\nhead(profile_lst)\n\n\n# A tibble: 6 × 4\n  ProfileID ProfileName       DomainID DomainName                               \n      &lt;int&gt; &lt;chr&gt;                &lt;int&gt; &lt;chr&gt;                                    \n1        18 Smoking Profile 1938132885 Key indicators                           \n2        18 Smoking Profile 1938132886 Smoking prevalence in adults             \n3        18 Smoking Profile 1938132900 Smoking prevalence in priority populatio…\n4        18 Smoking Profile 1938132887 Smoking related mortality                \n5        18 Smoking Profile 1938132888 Smoking related ill health               \n6        18 Smoking Profile 1938132889 Impact of smoking                        \n\n\n\n\nAsthma Indicators\nExtracting health indicators specifically for asthma conditions using domain code 8000009.\n\n\nShow the code\nindicator_lst_asthma &lt;- indicators(DomainID = 8000009)\n\nindicator_lst_asthma |&gt;\n  head(10) |&gt;\n  knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\nIndicatorID\nIndicatorName\nDomainID\nDomainName\nProfileID\nProfileName\n\n\n\n\n90810\nHospital admissions for asthma (under 19 years)\n8000009\nAsthma\n29\nRespiratory disease\n\n\n90933\nAsthma: QOF prevalence\n8000009\nAsthma\n29\nRespiratory disease\n\n\n93573\nEmergency hospital admissions for asthma in adults (aged 19 years and over)\n8000009\nAsthma\n29\nRespiratory disease\n\n\n93594\nMedian length of stay (days) of emergency admissions to hospital for asthma in adults (aged 19 years and over)\n8000009\nAsthma\n29\nRespiratory disease\n\n\n93595\nMedian length of stay (days) of emergency admissions to hospital for asthma (aged under 19 years)\n8000009\nAsthma\n29\nRespiratory disease\n\n\n93644\nMortality rate from asthma\n8000009\nAsthma\n29\nRespiratory disease\n\n\n93790\nPatients with Asthma: review in the last 12 months (denominator incl. PCAs)\n8000009\nAsthma\n29\nRespiratory disease\n\n\n93791\nPatients with Asthma (6-19 yrs): Second-hand smoking status recorded in the last 12 months (denominator incl. PCAs)\n8000009\nAsthma\n29\nRespiratory disease\n\n\n\n\n\n\n\nRespiratory Disease Indicators\nObtaining indicators for broader respiratory diseases using profile code 29.\n\n\nShow the code\nindicator_lst_resp &lt;- indicators(ProfileID = 29)\n\nindicator_lst_resp |&gt;\n  head(10) |&gt;\n  knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\nIndicatorID\nIndicatorName\nDomainID\nDomainName\nProfileID\nProfileName\n\n\n\n\n253\nCOPD: QOF prevalence\n8000003\nKey indicators\n29\nRespiratory disease\n\n\n1204\nMortality rate from chronic obstructive pulmonary disease, all ages\n8000003\nKey indicators\n29\nRespiratory disease\n\n\n40701\nUnder 75 mortality rate from respiratory disease\n8000003\nKey indicators\n29\nRespiratory disease\n\n\n90810\nHospital admissions for asthma (under 19 years)\n8000003\nKey indicators\n29\nRespiratory disease\n\n\n90933\nAsthma: QOF prevalence\n8000003\nKey indicators\n29\nRespiratory disease\n\n\n93573\nEmergency hospital admissions for asthma in adults (aged 19 years and over)\n8000003\nKey indicators\n29\nRespiratory disease\n\n\n93574\nEmergency hospital admissions for pneumonia\n8000003\nKey indicators\n29\nRespiratory disease\n\n\n93575\nEmergency hospital admissions for respiratory disease\n8000003\nKey indicators\n29\nRespiratory disease\n\n\n93576\nEmergency hospital admissions for bronchiolitis in children aged under 2 years\n8000003\nKey indicators\n29\nRespiratory disease\n\n\n93577\nEmergency hospital admissions for COPD, all ages\n8000003\nKey indicators\n29\nRespiratory disease\n\n\n\n\n\n\n\nIndicator Selection\nCreating an object for the Hospital Admissions indicator.\n\n\nShow the code\n# sel_indicator &lt;- indicator_lst_resp |&gt;\n#   pull(IndicatorID)\n\nsel_indicator &lt;- 90810\n\n\n\n\nArea Type Mapping\nDetermining which geographic area types are available for the selected health indicator.\n\n\nShow the code\narea_avail_ind &lt;- do.call(\n  bind_rows,\n  lapply(sel_indicator, \\(x) indicator_areatypes(IndicatorID = x))\n)\n\n\n\n\nGeographic Classifications\nRetrieving all available area type classifications for spatial analysis.\n\n\nShow the code\narea_ty_lst &lt;- area_types()\n\n\n\n\nData Integration\nJoining indicator and area type information with descriptive names for clarity.\n\n\nShow the code\narea_avail_ind_names &lt;- area_avail_ind |&gt;\n  left_join(\n    indicator_lst_resp |&gt;\n      select(IndicatorID, IndicatorName) |&gt;\n      unique(),\n    by = join_by(IndicatorID)\n  ) |&gt;\n  left_join(\n    area_ty_lst |&gt;\n      select(AreaTypeID, AreaTypeName) |&gt;\n      unique(),\n    by = join_by(AreaTypeID)\n  )\n\nslice_sample(area_avail_ind_names, n = 15) |&gt;\n  select(-IndicatorID, -AreaTypeID) |&gt;\n  knitr::kable()\n\n\n\n\n\n\n\n\n\nIndicatorName\nAreaTypeName\n\n\n\n\nHospital admissions for asthma (under 19 years)\nEngland\n\n\nHospital admissions for asthma (under 19 years)\nICBs, former STPs\n\n\nHospital admissions for asthma (under 19 years)\nUpper tier local authorities (4/21-3/23)\n\n\nHospital admissions for asthma (under 19 years)\nGovernment Office Region (E12)\n\n\nHospital admissions for asthma (under 19 years)\nLower tier local authorities (4/21-3/23)\n\n\nHospital admissions for asthma (under 19 years)\nLower tier local authorities (post 4/23)\n\n\nHospital admissions for asthma (under 19 years)\nNHS regions\n\n\nHospital admissions for asthma (under 19 years)\nUpper tier local authorities (post 4/23)\n\n\nHospital admissions for asthma (under 19 years)\nUpper tier local authorities (4/20-3/21)\n\n\n\n\n\n\n\nSample Data Extraction\nDownloading actual data for the indicator Lower and Upper tier LAs.\n\n\nShow the code\ntemp_data &lt;- fingertips_data(\n  IndicatorID = area_avail_ind$IndicatorID[1],\n  AreaTypeID = \"All\"\n)\n\n\n\n  |                                                                            \n  |                                                                      |   0%\n  |                                                                            \n  |==========                                                            |  14%\n  |                                                                            \n  |====================                                                  |  29%\n  |                                                                            \n  |==============================                                        |  43%\n  |                                                                            \n  |========================================                              |  57%\n  |                                                                            \n  |==================================================                    |  71%\n  |                                                                            \n  |============================================================          |  86%\n  |                                                                            \n  |======================================================================| 100%\n\n\nShow the code\ntemp_data |&gt; sample_n(10) |&gt; knitr::kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nIndicatorID\nIndicatorName\nParentCode\nParentName\nAreaCode\nAreaName\nAreaType\nSex\nAge\nCategoryType\nCategory\nTimeperiod\nValue\nLowerCI95.0limit\nUpperCI95.0limit\nLowerCI99.8limit\nUpperCI99.8limit\nCount\nDenominator\nValuenote\nRecentTrend\nComparedtoEnglandvalueorpercentiles\nComparedtoParentvalueorpercentiles\nTimeperiodSortable\nNewdata\nComparedtogoal\nTimeperiodrange\n\n\n\n\n90810\nHospital admissions for asthma (under 19 years)\nE92000001\nEngland\nE09000004\nBexley\nCounties & UAs (2021/22-2022/23)\nMale\n0-9 yrs\nNA\nNA\n2020/21\n153.78937\n109.43015\n241.6652\n84.29098\n290.7698\n25\n16256\nNA\nNA\nSimilar\nNot compared\n20200000\nNA\nNA\n1y\n\n\n90810\nHospital admissions for asthma (under 19 years)\nE92000001\nEngland\nnE54000018\nNHS Coventry and Warwickshire Integrated Care Board - QWU\nICBs\nMale\n10-18 yrs\nNA\nNA\n2017/18\n172.22449\n132.72820\n209.5730\n115.19136\n235.4270\n80\n46451\nNA\nNA\nWorse\nNot compared\n20170000\nNA\nNA\n1y\n\n\n90810\nHospital admissions for asthma (under 19 years)\nE92000001\nEngland\nE08000022\nNorth Tyneside\nCounties & UAs (from Apr 2023)\nFemale\n0-18 yrs\nNA\nNA\n2020/21\n94.08223\n50.15756\n133.8284\n35.87002\n166.5107\n20\n21258\nNA\nNA\nSimilar\nNot compared\n20200000\nNA\nNA\n1y\n\n\n90810\nHospital admissions for asthma (under 19 years)\nE92000001\nEngland\nE09000029\nSutton\nCounties & UAs (from Apr 2023)\nFemale\n0-18 yrs\nNA\nNA\n2018/19\n207.27107\n150.26145\n268.5487\n124.99941\n309.8798\n50\n24123\nNA\nNA\nSimilar\nNot compared\n20180000\nNA\nNA\n1y\n\n\n90810\nHospital admissions for asthma (under 19 years)\nE92000001\nEngland\nE08000029\nSolihull\nCounties & UAs (from Apr 2023)\nPersons\n0-9 yrs\nNA\nNA\n2014/15\n161.64882\n112.06092\n215.4607\n90.83864\n252.3769\n40\n24745\nNA\nNA\nBetter\nNot compared\n20140000\nNA\nNA\n1y\n\n\n90810\nHospital admissions for asthma (under 19 years)\nE92000001\nEngland\nE09000021\nKingston upon Thames\nDistricts & UAs (2021/22-2022/23)\nMale\n0-18 yrs\nNA\nNA\n2018/19\n258.91979\n201.09415\n353.1275\n168.31513\n405.9707\n50\n19311\nNA\nNA\nSimilar\nNot compared\n20180000\nNA\nNA\n1y\n\n\n90810\nHospital admissions for asthma (under 19 years)\nE92000001\nEngland\nE09000026\nRedbridge\nCounties & UAs (2021/22-2022/23)\nPersons\n0-18 yrs\nNA\nNA\n2021/22\n155.52100\n129.45225\n185.2976\n116.03247\n203.5102\n125\n80375\nNA\nNA\nSimilar\nNot compared\n20210000\nNA\nNA\n1y\n\n\n90810\nHospital admissions for asthma (under 19 years)\nE92000001\nEngland\nE06000057\nNorthumberland\nDistricts & UAs (from Apr 2023)\nPersons\n0-9 yrs\nNA\nNA\n2015/16\n156.67105\n121.68106\n213.6757\n101.84663\n245.6508\n50\n31914\nNA\nNA\nBetter\nNot compared\n20150000\nNA\nNA\n1y\n\n\n90810\nHospital admissions for asthma (under 19 years)\nE92000001\nEngland\nE10000016\nKent\nCounties & UAs (2020/21)\nPersons\n0-9 yrs\nNA\nNA\n2022/23\n152.45978\n134.61016\n170.8279\n125.34770\n182.1799\n280\n183655\nNA\nNA\nSimilar\nNot compared\n20220000\nNA\nNA\n1y\n\n\n90810\nHospital admissions for asthma (under 19 years)\nE92000001\nEngland\nE08000012\nLiverpool\nDistricts & UAs (from Apr 2023)\nPersons\n0-18 yrs\nNA\nNA\n2014/15\n305.98787\n273.76848\n345.5414\n255.36172\n367.9966\n290\n94775\nNA\nNA\nWorse\nNot compared\n20140000\nNA\nNA\n1y\n\n\n\n\n\n\n\nShow the code\nwrite_csv(temp_data, \"data_raw/hospital_admissions.csv\", append = F)",
    "crumbs": [
      "Data",
      "Health indicators"
    ]
  },
  {
    "objectID": "qmds_ghpages/practice_data.html",
    "href": "qmds_ghpages/practice_data.html",
    "title": "GP Practices",
    "section": "",
    "text": "This section focuses on acquiring and processing data about General Practice (GP) surgeries across England. GP practices serve as the primary point of contact for patients in the NHS system and are therefore crucial for understanding healthcare utilisation patterns in different geographic areas.\nFor the CAZ health analysis, GP practice data serves several important purposes:\n\nSpatial reference points: Practice locations help link health data to specific geographic areas, allowing us to determine which practices serve populations within or near Clean Air Zones\nDenominator data: Patient registration numbers provide the population base needed to calculate prescription rates and health indicator ratios\nGeographic stratification: Practices can be classified by their proximity to CAZ boundaries to compare health outcomes across different exposure levels\n\nThe analysis uses data from OpenPrescribing.net, which provides comprehensive information about NHS prescribing patterns and practice characteristics. This includes practice locations, patient registration numbers, and prescribing volumes, all of which are essential for our spatial health analysis.\nBy mapping GP practices in relation to CAZ boundaries, we can create meaningful comparison groups for evaluating the health impacts of air quality interventions.\n\n\n\n\n\nLoading required packages for spatial analysis and web scraping.\n\n\nShow the code\noptions(repos = c(CRAN = \"https://cloud.r-project.org\"))\nif (!require(\"remotes\")) {\n  install.packages(\"remotes\")\n}\npkgs = c(\n  \"sf\",\n  \"tidyverse\",\n  \"here\",\n  \"tmap\",\n  \"geojsonsf\",\n  \"rvest\"\n)\n\nremotes::install_cran(pkgs)\nsapply(pkgs, require, character.only = TRUE)\n\n\n       sf tidyverse      here      tmap geojsonsf     rvest \n     TRUE      TRUE      TRUE      TRUE      TRUE      TRUE \n\n\n\n\n\n\n\n\nDownloading Sub-ICB (Clinical Commissioning Group) boundary data from OpenPrescribing.\n\n\nShow the code\nif (!file.exists(\"data_raw/subicb_boundaries.gpkg\")) {\n  u &lt;- \"https://openprescribing.net/api/1.0/org_location/?org_type=ccg\"\n  subicb_boundaries &lt;- geojsonsf::geojson_sf(u) |&gt;\n    st_transform(27700)\n\n  st_write(\n    subicb_boundaries,\n    dsn = file.path(here(), \"data_raw\", \"subicb_boundaries.gpkg\"),\n    append = FALSE\n  )\n} else {\n  subicb_boundaries &lt;- st_read(file.path(\n    here(),\n    \"data_raw\",\n    \"subicb_boundaries.gpkg\"\n  ))\n}\n\n\nReading layer `subicb_boundaries' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\subicb_boundaries.gpkg' \n  using driver `GPKG'\nSimple feature collection with 106 features and 4 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 87318.43 ymin: 7053.782 xmax: 655646.4 ymax: 657547.7\nProjected CRS: OSGB36 / British National Grid\n\n\n\n\n\nObtaining the location of GP practices from OpenPrescribing for each Sub-ICB\nDownloading GP practice locations for each Sub-ICB area from the OpenPrescribing API.\n\n\nShow the code\nif (!file.exists(\"data_raw/gp_locations.gpkg\")) {\n  all_practices &lt;- lapply(subicb_boundaries$code, \\(t_code) {\n    geojsonsf::geojson_sf(\n      paste0(\"https://openprescribing.net/api/1.0/org_location/?q=\", t_code)\n    ) |&gt;\n      st_transform(27700) |&gt;\n      mutate(par_code = t_code)\n  }) |&gt;\n    bind_rows()\n\n  st_write(\n    all_practices,\n    dsn = file.path(here(), \"data_raw\", \"gp_locations.gpkg\"),\n    append = FALSE\n  )\n} else {\n  all_practices &lt;- st_read(file.path(here(), \"data_raw\", \"gp_locations.gpkg\"))\n}\n\n\nReading layer `gp_locations' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\gp_locations.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11968 features and 4 fields (with 7 geometries empty)\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 90774 ymin: 10282 xmax: 655043 ymax: 653236\nProjected CRS: OSGB36 / British National Grid\n\n\n\n\n\nLoading previously created CAZ buffer zones for spatial analysis.\n\n\nShow the code\ncaz_buffers &lt;- st_read(file.path(here(), \"data_raw\", \"CAZ_buffers.gpkg\"))\n\n\nReading layer `CAZ_buffers' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\CAZ_buffers.gpkg' \n  using driver `GPKG'\nSimple feature collection with 35 features and 2 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 346347.5 ymin: 89474.96 xmax: 475150.8 ymax: 575397.8\nProjected CRS: OSGB36 / British National Grid\n\n\nIdentifying GP practices located within CAZ buffer zones.\n\n\nShow the code\ncaz_practices &lt;- all_practices[caz_buffers, ]\n\n\nClassifying practices by their distance from CAZ boundaries and assigning CAZ names.\n\n\nShow the code\npractices_intersects &lt;- st_intersects(caz_practices, caz_buffers)\n\ncaz_practices$buffer_km &lt;- vapply(\n  practices_intersects,\n  \\(caz_index) {\n    caz_buffers$buffer_km[caz_index] |&gt; min()\n  },\n  FUN.VALUE = numeric(1)\n)\n\ncaz_practices$CAZ_name &lt;- vapply(\n  practices_intersects,\n  \\(caz_index) {\n    caz_buffers$name[caz_index][which.min(caz_buffers$buffer_km[caz_index])]\n  },\n  FUN.VALUE = character(1)\n)\n\n\n\n\nShow the code\ntmap_mode(\"view\")\nbuffers &lt;- c(0, 0.5, 1, 5, 10) * 1e3\n\ntm_shape(caz_buffers |&gt; arrange(-buffer_km)) +\n  tm_polygons(\n    \"buffer_km\",\n    fill_alpha = 0.4,\n    fill.scale = tm_scale_discrete(\n      ticks = buffers / 1e3,\n      values = \"-brewer.blues\"\n    )\n  ) +\n  tm_shape(caz_practices) +\n  tm_dots(\"CAZ_name\")\n\n\n\n\n\n\n\n\n\n\nShow the code\nst_write(\n  caz_practices,\n  dsn = file.path(here(), \"data_raw\", \"CAZ_practices.gpkg\"),\n  append = FALSE\n)\n\n\nDeleting layer `CAZ_practices' using driver `GPKG'\nWriting layer `CAZ_practices' to data source \n  `C:/temp_jf/CAZ-health-data-trends/data_raw/CAZ_practices.gpkg' using driver `GPKG'\nWriting 1362 features with 6 fields and geometry type Point.\n\n\n\n\n\n\nFrom the NHS we can extract total number of patients registered after each month. This code downloads all monthly reports programmatically, extracts the zip files, and saves a consolidated dataset as a csv file.\n\n\nShow the code\nif (!file.exists(file.path(here(), \"data_raw\", \"practice_patients.csv\"))) {\n  get_patients &lt;- function() {\n    base_u &lt;- \"https://digital.nhs.uk/data-and-information/publications/statistical/patients-registered-at-a-gp-practice/\"\n\n    my_grid &lt;- expand.grid(month = tolower(month.name), year = 2020:2024)\n    my_grid$u &lt;- paste(my_grid$month, my_grid$year, sep = \"-\")\n\n    folder_path &lt;- \"gp_patients\"\n\n    dir.create(path = folder_path, showWarnings = F)\n\n    cur_files &lt;- tools::file_path_sans_ext(list.files(folder_path))\n\n    my_grid &lt;- my_grid[!(my_grid$u %in% cur_files), ]\n\n    for (i in my_grid$u) {\n      print(paste0(base_u, i))\n      w &lt;- read_html(paste0(base_u, i))\n\n      links &lt;- w |&gt; html_nodes(\"a\") |&gt; html_attr(\"href\")\n\n      my_link &lt;- links[grep(links, pattern = \"gp-reg-pat-prac-all\")]\n\n      download.file(\n        url = my_link,\n        destfile = paste0(folder_path, \"/\", i, \".\", tools::file_ext(my_link)),\n        mode = \"wb\"\n      )\n\n      Sys.sleep(rnorm(1, mean = 5))\n    }\n\n    # List all ZIP files in the folder\n    zip_files &lt;- list.files(\n      path = folder_path,\n      pattern = \"\\\\.zip$\",\n      full.names = TRUE\n    )\n\n    # Extract each ZIP file\n    lapply(zip_files, function(zip_file) {\n      # Create a temporary directory for extraction\n      temp_dir &lt;- tempfile()\n      dir.create(temp_dir)\n\n      # Extract the ZIP file into the temporary directory\n      unzip(zip_file, exdir = temp_dir)\n\n      # List extracted files\n      extracted_files &lt;- list.files(path = temp_dir, full.names = TRUE)\n\n      # Move and rename each extracted file to the original folder\n      lapply(extracted_files, function(file) {\n        file_extension &lt;- tools::file_ext(file)\n        new_name &lt;- file.path(\n          folder_path,\n          paste0(\n            tools::file_path_sans_ext(basename(zip_file)),\n            \".\",\n            file_extension\n          )\n        )\n        file.rename(file, new_name)\n      })\n\n      # Remove the temporary directory\n      unlink(temp_dir, recursive = TRUE)\n    })\n\n    all_data &lt;- lapply(\n      list.files(\n        path = \"gp_patients\",\n        pattern = \"\\\\.csv$\",\n        full.names = T\n      ),\n      \\(x) {\n        read_csv(x) |&gt;\n          mutate(\n            month = str_extract(basename(x), \"[a-zA-Z]+(?=-)\"),\n            year = str_extract(basename(x), \"\\\\d{4}\")\n          )\n      }\n    )\n\n    common_names &lt;- reduce(lapply(all_data, names), intersect)\n\n    all_data_df &lt;- do.call(\n      rbind,\n      lapply(all_data, \\(x) {\n        x[, common_names]\n      })\n    ) |&gt;\n      mutate(year = as.integer(year))\n\n    write_csv(\n      all_data_df,\n      file = file.path(here(), \"data_raw\", \"practice_patients.csv\")\n    )\n  }\n\n  get_patients()\n} else {\n  all_data_df &lt;- read_csv(\n    file.path(here(), \"data_raw\", \"practice_patients.csv\"),\n    col_types = cols(\n      PUBLICATION = col_character(),\n      EXTRACT_DATE = col_character(),\n      TYPE = col_character(),\n      CODE = col_character(),\n      POSTCODE = col_character(),\n      SEX = col_character(),\n      AGE = col_character(),\n      NUMBER_OF_PATIENTS = col_double(),\n      month = col_character(),\n      year = col_double()\n    )\n  )\n}\n\n\nWe can also download data to know the number of registered patients by year of age and sex\n\n\nShow the code\nif (!file.exists(file.path(here(), \"data_raw\", \"practice_patients_age.csv\"))) {\n  get_patients &lt;- function() {\n    base_u &lt;- \"https://digital.nhs.uk/data-and-information/publications/statistical/patients-registered-at-a-gp-practice/\"\n\n    my_grid &lt;- expand.grid(month = tolower(month.name), year = 2020:2024)\n    my_grid$u &lt;- paste(my_grid$month, my_grid$year, sep = \"-\")\n\n    folder_path &lt;- \"gp_patients_age\"\n\n    dir.create(path = folder_path, showWarnings = F)\n\n    cur_files &lt;- tools::file_path_sans_ext(list.files(folder_path))\n\n    my_grid &lt;- my_grid[!(my_grid$u %in% cur_files), ]\n\n    for (i in my_grid$u) {\n      print(paste0(base_u, i))\n      w &lt;- read_html(paste0(base_u, i))\n\n      links &lt;- w |&gt; html_nodes(\"a\") |&gt; html_attr(\"href\")\n\n      my_link &lt;- links[grep(\n        links,\n        pattern = \"gp-reg-pat-prac-sing-age-(fe)?male\"\n      )]\n\n      for (tlink in my_link) {\n        j &lt;- str_extract(tlink, pattern = \"(fe)?male\")\n\n        download.file(\n          url = tlink,\n          destfile = paste0(\n            folder_path,\n            \"/\",\n            i,\n            \"-\",\n            j,\n            \".\",\n            tools::file_ext(tlink)\n          ),\n          mode = \"wb\"\n        )\n      }\n\n      Sys.sleep(rnorm(1, mean = 5))\n    }\n\n    # List all ZIP files in the folder\n    zip_files &lt;- list.files(\n      path = folder_path,\n      pattern = \"\\\\.zip$\",\n      full.names = TRUE\n    )\n\n    # Extract each ZIP file\n    lapply(zip_files, function(zip_file) {\n      # Create a temporary directory for extraction\n      temp_dir &lt;- tempfile()\n      dir.create(temp_dir)\n\n      # Extract the ZIP file into the temporary directory\n      unzip(zip_file, exdir = temp_dir)\n\n      # List extracted files\n      extracted_files &lt;- list.files(path = temp_dir, full.names = TRUE)\n\n      # Move and rename each extracted file to the original folder\n      lapply(extracted_files, function(file) {\n        file_extension &lt;- tools::file_ext(file)\n        new_name &lt;- file.path(\n          folder_path,\n          paste0(\n            tools::file_path_sans_ext(basename(zip_file)),\n            \".\",\n            file_extension\n          )\n        )\n        file.rename(file, new_name)\n      })\n\n      # Remove the temporary directory\n      unlink(temp_dir, recursive = TRUE)\n    })\n\n    all_data &lt;- lapply(\n      list.files(\n        path = \"gp_patients_age\",\n        pattern = \"\\\\.csv$\",\n        full.names = T\n      ),\n      \\(x) {\n        read_csv(x) |&gt;\n          mutate(\n            month = str_extract(basename(x), \"[a-zA-Z]+(?=-)\"),\n            year = str_extract(basename(x), \"\\\\d{4}\")\n          )\n      }\n    )\n\n    common_names &lt;- reduce(lapply(all_data, names), intersect)\n\n    all_data_df_age &lt;- do.call(\n      rbind,\n      lapply(all_data, \\(x) {\n        x[, common_names]\n      })\n    ) |&gt;\n      mutate(year = as.integer(year))\n\n    all_data_df_age = data.table::as.data.table(all_data_df_age)\n\n    all_data_df_age[,\n      AGE_GROUP := cut(\n        as.numeric(AGE),\n        breaks = seq(0, 120, 10),\n        include.lowest = TRUE\n      )\n    ]\n\n    all_data_df_age_summary &lt;- all_data_df_age[\n      !is.na(AGE_GROUP),\n      .(NUMBER_OF_PATIENTS = sum(NUMBER_OF_PATIENTS)),\n      by = .(ORG_CODE, AGE_GROUP, month, year)\n    ]\n\n    write_csv(\n      all_data_df_age_summary,\n      file = file.path(here(), \"data_raw\", \"practice_patients_age.csv\")\n    )\n  }\n\n  get_patients()\n} else {\n  all_data_df_age &lt;- read_csv(\n    file.path(here(), \"data_raw\", \"practice_patients_age.csv\"),\n    col_types = cols(\n      ORG_CODE = col_character(),\n      AGE_GROUP = col_character(),\n      month = col_character(),\n      year = col_double(),\n      NUMBER_OF_PATIENTS = col_double()\n    )\n  )\n}\n\n\n\n\n\n\nShow the code\ntmap_mode(\"plot\")\n\n\nsf_practices_size &lt;- all_practices |&gt;\n  left_join(\n    all_data_df |&gt;\n      summarise(\n        across(NUMBER_OF_PATIENTS, \\(x) median(x, na.rm = T)),\n        .by = CODE\n      ),\n    by = c(\"code\" = \"CODE\")\n  )\n\nsf_practices_size |&gt;\n  filter(NUMBER_OF_PATIENTS &lt;= quantile(NUMBER_OF_PATIENTS, 0.9, na.rm = T)) |&gt;\n  arrange(-NUMBER_OF_PATIENTS) |&gt;\n  tm_shape() +\n  tm_symbols(\n    fill = \"NUMBER_OF_PATIENTS\",\n    size = \"NUMBER_OF_PATIENTS\",\n    col = NA,\n    size.scale = tm_scale_continuous(values.scale = 0.5),\n    size.legend = tm_legend_hide(),\n    # fill_alpha = 0.4,\n    fill.scale = tm_scale_intervals(n = 5, values = \"-tol.rainbow_wh_br\")\n  )\n\n\n\n\n\n\n\n\n\nAge distribution\n\n\nShow the code\nlibrary(data.table)\npractice_avg_age &lt;- as.data.table(all_data_df_age)[,\n  `:=`(\n    lower = as.numeric(str_extract(AGE_GROUP, \"(?&lt;=(\\\\(|\\\\[))\\\\d{1,2}\")),\n    upper = as.numeric(str_extract(AGE_GROUP, \"\\\\d{2,3}(?=(\\\\)|\\\\]))\"))\n  )\n][,\n  midpoint := 0.5 * (lower + upper)\n][,\n  .(mean_age = weighted.mean(midpoint, NUMBER_OF_PATIENTS)),\n  by = .(ORG_CODE, month, year)\n]\n\n\nNational mean age distribution\n\n\nShow the code\npractice_avg_age |&gt;\n  filter(year == 2024, month == \"december\") |&gt;\n  ggplot(aes(mean_age)) +\n  stat_ecdf() +\n  theme_minimal()\n\n\n\n\n\n\n\n\n\nSpatial distribution\n\n\nShow the code\nsf_practices_age &lt;- all_practices |&gt;\n  left_join(\n    practice_avg_age |&gt;\n      filter(year == 2024, month == \"december\"),\n    by = c(\"code\" = \"ORG_CODE\")\n  ) |&gt;\n  drop_na()\n\nsf_practices_age |&gt;\n  arrange(mean_age) |&gt;\n  ggplot(aes(col = mean_age)) +\n  geom_sf(alpha = 0.7) +\n  theme_void() +\n  scale_color_continuous(palette = \"viridis\")",
    "crumbs": [
      "Data",
      "GP Practices"
    ]
  },
  {
    "objectID": "qmds_ghpages/practice_data.html#overview",
    "href": "qmds_ghpages/practice_data.html#overview",
    "title": "GP Practices",
    "section": "",
    "text": "This section focuses on acquiring and processing data about General Practice (GP) surgeries across England. GP practices serve as the primary point of contact for patients in the NHS system and are therefore crucial for understanding healthcare utilisation patterns in different geographic areas.\nFor the CAZ health analysis, GP practice data serves several important purposes:\n\nSpatial reference points: Practice locations help link health data to specific geographic areas, allowing us to determine which practices serve populations within or near Clean Air Zones\nDenominator data: Patient registration numbers provide the population base needed to calculate prescription rates and health indicator ratios\nGeographic stratification: Practices can be classified by their proximity to CAZ boundaries to compare health outcomes across different exposure levels\n\nThe analysis uses data from OpenPrescribing.net, which provides comprehensive information about NHS prescribing patterns and practice characteristics. This includes practice locations, patient registration numbers, and prescribing volumes, all of which are essential for our spatial health analysis.\nBy mapping GP practices in relation to CAZ boundaries, we can create meaningful comparison groups for evaluating the health impacts of air quality interventions.",
    "crumbs": [
      "Data",
      "GP Practices"
    ]
  },
  {
    "objectID": "qmds_ghpages/practice_data.html#setup",
    "href": "qmds_ghpages/practice_data.html#setup",
    "title": "GP Practices",
    "section": "",
    "text": "Loading required packages for spatial analysis and web scraping.\n\n\nShow the code\noptions(repos = c(CRAN = \"https://cloud.r-project.org\"))\nif (!require(\"remotes\")) {\n  install.packages(\"remotes\")\n}\npkgs = c(\n  \"sf\",\n  \"tidyverse\",\n  \"here\",\n  \"tmap\",\n  \"geojsonsf\",\n  \"rvest\"\n)\n\nremotes::install_cran(pkgs)\nsapply(pkgs, require, character.only = TRUE)\n\n\n       sf tidyverse      here      tmap geojsonsf     rvest \n     TRUE      TRUE      TRUE      TRUE      TRUE      TRUE",
    "crumbs": [
      "Data",
      "GP Practices"
    ]
  },
  {
    "objectID": "qmds_ghpages/practice_data.html#loading-spatial-data",
    "href": "qmds_ghpages/practice_data.html#loading-spatial-data",
    "title": "GP Practices",
    "section": "",
    "text": "Downloading Sub-ICB (Clinical Commissioning Group) boundary data from OpenPrescribing.\n\n\nShow the code\nif (!file.exists(\"data_raw/subicb_boundaries.gpkg\")) {\n  u &lt;- \"https://openprescribing.net/api/1.0/org_location/?org_type=ccg\"\n  subicb_boundaries &lt;- geojsonsf::geojson_sf(u) |&gt;\n    st_transform(27700)\n\n  st_write(\n    subicb_boundaries,\n    dsn = file.path(here(), \"data_raw\", \"subicb_boundaries.gpkg\"),\n    append = FALSE\n  )\n} else {\n  subicb_boundaries &lt;- st_read(file.path(\n    here(),\n    \"data_raw\",\n    \"subicb_boundaries.gpkg\"\n  ))\n}\n\n\nReading layer `subicb_boundaries' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\subicb_boundaries.gpkg' \n  using driver `GPKG'\nSimple feature collection with 106 features and 4 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 87318.43 ymin: 7053.782 xmax: 655646.4 ymax: 657547.7\nProjected CRS: OSGB36 / British National Grid\n\n\n\n\n\nObtaining the location of GP practices from OpenPrescribing for each Sub-ICB\nDownloading GP practice locations for each Sub-ICB area from the OpenPrescribing API.\n\n\nShow the code\nif (!file.exists(\"data_raw/gp_locations.gpkg\")) {\n  all_practices &lt;- lapply(subicb_boundaries$code, \\(t_code) {\n    geojsonsf::geojson_sf(\n      paste0(\"https://openprescribing.net/api/1.0/org_location/?q=\", t_code)\n    ) |&gt;\n      st_transform(27700) |&gt;\n      mutate(par_code = t_code)\n  }) |&gt;\n    bind_rows()\n\n  st_write(\n    all_practices,\n    dsn = file.path(here(), \"data_raw\", \"gp_locations.gpkg\"),\n    append = FALSE\n  )\n} else {\n  all_practices &lt;- st_read(file.path(here(), \"data_raw\", \"gp_locations.gpkg\"))\n}\n\n\nReading layer `gp_locations' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\gp_locations.gpkg' \n  using driver `GPKG'\nSimple feature collection with 11968 features and 4 fields (with 7 geometries empty)\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 90774 ymin: 10282 xmax: 655043 ymax: 653236\nProjected CRS: OSGB36 / British National Grid\n\n\n\n\n\nLoading previously created CAZ buffer zones for spatial analysis.\n\n\nShow the code\ncaz_buffers &lt;- st_read(file.path(here(), \"data_raw\", \"CAZ_buffers.gpkg\"))\n\n\nReading layer `CAZ_buffers' from data source \n  `C:\\temp_jf\\CAZ-health-data-trends\\data_raw\\CAZ_buffers.gpkg' \n  using driver `GPKG'\nSimple feature collection with 35 features and 2 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 346347.5 ymin: 89474.96 xmax: 475150.8 ymax: 575397.8\nProjected CRS: OSGB36 / British National Grid\n\n\nIdentifying GP practices located within CAZ buffer zones.\n\n\nShow the code\ncaz_practices &lt;- all_practices[caz_buffers, ]\n\n\nClassifying practices by their distance from CAZ boundaries and assigning CAZ names.\n\n\nShow the code\npractices_intersects &lt;- st_intersects(caz_practices, caz_buffers)\n\ncaz_practices$buffer_km &lt;- vapply(\n  practices_intersects,\n  \\(caz_index) {\n    caz_buffers$buffer_km[caz_index] |&gt; min()\n  },\n  FUN.VALUE = numeric(1)\n)\n\ncaz_practices$CAZ_name &lt;- vapply(\n  practices_intersects,\n  \\(caz_index) {\n    caz_buffers$name[caz_index][which.min(caz_buffers$buffer_km[caz_index])]\n  },\n  FUN.VALUE = character(1)\n)\n\n\n\n\nShow the code\ntmap_mode(\"view\")\nbuffers &lt;- c(0, 0.5, 1, 5, 10) * 1e3\n\ntm_shape(caz_buffers |&gt; arrange(-buffer_km)) +\n  tm_polygons(\n    \"buffer_km\",\n    fill_alpha = 0.4,\n    fill.scale = tm_scale_discrete(\n      ticks = buffers / 1e3,\n      values = \"-brewer.blues\"\n    )\n  ) +\n  tm_shape(caz_practices) +\n  tm_dots(\"CAZ_name\")\n\n\n\n\n\n\n\n\n\n\nShow the code\nst_write(\n  caz_practices,\n  dsn = file.path(here(), \"data_raw\", \"CAZ_practices.gpkg\"),\n  append = FALSE\n)\n\n\nDeleting layer `CAZ_practices' using driver `GPKG'\nWriting layer `CAZ_practices' to data source \n  `C:/temp_jf/CAZ-health-data-trends/data_raw/CAZ_practices.gpkg' using driver `GPKG'\nWriting 1362 features with 6 fields and geometry type Point.",
    "crumbs": [
      "Data",
      "GP Practices"
    ]
  },
  {
    "objectID": "qmds_ghpages/practice_data.html#registered-patients-data",
    "href": "qmds_ghpages/practice_data.html#registered-patients-data",
    "title": "GP Practices",
    "section": "",
    "text": "From the NHS we can extract total number of patients registered after each month. This code downloads all monthly reports programmatically, extracts the zip files, and saves a consolidated dataset as a csv file.\n\n\nShow the code\nif (!file.exists(file.path(here(), \"data_raw\", \"practice_patients.csv\"))) {\n  get_patients &lt;- function() {\n    base_u &lt;- \"https://digital.nhs.uk/data-and-information/publications/statistical/patients-registered-at-a-gp-practice/\"\n\n    my_grid &lt;- expand.grid(month = tolower(month.name), year = 2020:2024)\n    my_grid$u &lt;- paste(my_grid$month, my_grid$year, sep = \"-\")\n\n    folder_path &lt;- \"gp_patients\"\n\n    dir.create(path = folder_path, showWarnings = F)\n\n    cur_files &lt;- tools::file_path_sans_ext(list.files(folder_path))\n\n    my_grid &lt;- my_grid[!(my_grid$u %in% cur_files), ]\n\n    for (i in my_grid$u) {\n      print(paste0(base_u, i))\n      w &lt;- read_html(paste0(base_u, i))\n\n      links &lt;- w |&gt; html_nodes(\"a\") |&gt; html_attr(\"href\")\n\n      my_link &lt;- links[grep(links, pattern = \"gp-reg-pat-prac-all\")]\n\n      download.file(\n        url = my_link,\n        destfile = paste0(folder_path, \"/\", i, \".\", tools::file_ext(my_link)),\n        mode = \"wb\"\n      )\n\n      Sys.sleep(rnorm(1, mean = 5))\n    }\n\n    # List all ZIP files in the folder\n    zip_files &lt;- list.files(\n      path = folder_path,\n      pattern = \"\\\\.zip$\",\n      full.names = TRUE\n    )\n\n    # Extract each ZIP file\n    lapply(zip_files, function(zip_file) {\n      # Create a temporary directory for extraction\n      temp_dir &lt;- tempfile()\n      dir.create(temp_dir)\n\n      # Extract the ZIP file into the temporary directory\n      unzip(zip_file, exdir = temp_dir)\n\n      # List extracted files\n      extracted_files &lt;- list.files(path = temp_dir, full.names = TRUE)\n\n      # Move and rename each extracted file to the original folder\n      lapply(extracted_files, function(file) {\n        file_extension &lt;- tools::file_ext(file)\n        new_name &lt;- file.path(\n          folder_path,\n          paste0(\n            tools::file_path_sans_ext(basename(zip_file)),\n            \".\",\n            file_extension\n          )\n        )\n        file.rename(file, new_name)\n      })\n\n      # Remove the temporary directory\n      unlink(temp_dir, recursive = TRUE)\n    })\n\n    all_data &lt;- lapply(\n      list.files(\n        path = \"gp_patients\",\n        pattern = \"\\\\.csv$\",\n        full.names = T\n      ),\n      \\(x) {\n        read_csv(x) |&gt;\n          mutate(\n            month = str_extract(basename(x), \"[a-zA-Z]+(?=-)\"),\n            year = str_extract(basename(x), \"\\\\d{4}\")\n          )\n      }\n    )\n\n    common_names &lt;- reduce(lapply(all_data, names), intersect)\n\n    all_data_df &lt;- do.call(\n      rbind,\n      lapply(all_data, \\(x) {\n        x[, common_names]\n      })\n    ) |&gt;\n      mutate(year = as.integer(year))\n\n    write_csv(\n      all_data_df,\n      file = file.path(here(), \"data_raw\", \"practice_patients.csv\")\n    )\n  }\n\n  get_patients()\n} else {\n  all_data_df &lt;- read_csv(\n    file.path(here(), \"data_raw\", \"practice_patients.csv\"),\n    col_types = cols(\n      PUBLICATION = col_character(),\n      EXTRACT_DATE = col_character(),\n      TYPE = col_character(),\n      CODE = col_character(),\n      POSTCODE = col_character(),\n      SEX = col_character(),\n      AGE = col_character(),\n      NUMBER_OF_PATIENTS = col_double(),\n      month = col_character(),\n      year = col_double()\n    )\n  )\n}\n\n\nWe can also download data to know the number of registered patients by year of age and sex\n\n\nShow the code\nif (!file.exists(file.path(here(), \"data_raw\", \"practice_patients_age.csv\"))) {\n  get_patients &lt;- function() {\n    base_u &lt;- \"https://digital.nhs.uk/data-and-information/publications/statistical/patients-registered-at-a-gp-practice/\"\n\n    my_grid &lt;- expand.grid(month = tolower(month.name), year = 2020:2024)\n    my_grid$u &lt;- paste(my_grid$month, my_grid$year, sep = \"-\")\n\n    folder_path &lt;- \"gp_patients_age\"\n\n    dir.create(path = folder_path, showWarnings = F)\n\n    cur_files &lt;- tools::file_path_sans_ext(list.files(folder_path))\n\n    my_grid &lt;- my_grid[!(my_grid$u %in% cur_files), ]\n\n    for (i in my_grid$u) {\n      print(paste0(base_u, i))\n      w &lt;- read_html(paste0(base_u, i))\n\n      links &lt;- w |&gt; html_nodes(\"a\") |&gt; html_attr(\"href\")\n\n      my_link &lt;- links[grep(\n        links,\n        pattern = \"gp-reg-pat-prac-sing-age-(fe)?male\"\n      )]\n\n      for (tlink in my_link) {\n        j &lt;- str_extract(tlink, pattern = \"(fe)?male\")\n\n        download.file(\n          url = tlink,\n          destfile = paste0(\n            folder_path,\n            \"/\",\n            i,\n            \"-\",\n            j,\n            \".\",\n            tools::file_ext(tlink)\n          ),\n          mode = \"wb\"\n        )\n      }\n\n      Sys.sleep(rnorm(1, mean = 5))\n    }\n\n    # List all ZIP files in the folder\n    zip_files &lt;- list.files(\n      path = folder_path,\n      pattern = \"\\\\.zip$\",\n      full.names = TRUE\n    )\n\n    # Extract each ZIP file\n    lapply(zip_files, function(zip_file) {\n      # Create a temporary directory for extraction\n      temp_dir &lt;- tempfile()\n      dir.create(temp_dir)\n\n      # Extract the ZIP file into the temporary directory\n      unzip(zip_file, exdir = temp_dir)\n\n      # List extracted files\n      extracted_files &lt;- list.files(path = temp_dir, full.names = TRUE)\n\n      # Move and rename each extracted file to the original folder\n      lapply(extracted_files, function(file) {\n        file_extension &lt;- tools::file_ext(file)\n        new_name &lt;- file.path(\n          folder_path,\n          paste0(\n            tools::file_path_sans_ext(basename(zip_file)),\n            \".\",\n            file_extension\n          )\n        )\n        file.rename(file, new_name)\n      })\n\n      # Remove the temporary directory\n      unlink(temp_dir, recursive = TRUE)\n    })\n\n    all_data &lt;- lapply(\n      list.files(\n        path = \"gp_patients_age\",\n        pattern = \"\\\\.csv$\",\n        full.names = T\n      ),\n      \\(x) {\n        read_csv(x) |&gt;\n          mutate(\n            month = str_extract(basename(x), \"[a-zA-Z]+(?=-)\"),\n            year = str_extract(basename(x), \"\\\\d{4}\")\n          )\n      }\n    )\n\n    common_names &lt;- reduce(lapply(all_data, names), intersect)\n\n    all_data_df_age &lt;- do.call(\n      rbind,\n      lapply(all_data, \\(x) {\n        x[, common_names]\n      })\n    ) |&gt;\n      mutate(year = as.integer(year))\n\n    all_data_df_age = data.table::as.data.table(all_data_df_age)\n\n    all_data_df_age[,\n      AGE_GROUP := cut(\n        as.numeric(AGE),\n        breaks = seq(0, 120, 10),\n        include.lowest = TRUE\n      )\n    ]\n\n    all_data_df_age_summary &lt;- all_data_df_age[\n      !is.na(AGE_GROUP),\n      .(NUMBER_OF_PATIENTS = sum(NUMBER_OF_PATIENTS)),\n      by = .(ORG_CODE, AGE_GROUP, month, year)\n    ]\n\n    write_csv(\n      all_data_df_age_summary,\n      file = file.path(here(), \"data_raw\", \"practice_patients_age.csv\")\n    )\n  }\n\n  get_patients()\n} else {\n  all_data_df_age &lt;- read_csv(\n    file.path(here(), \"data_raw\", \"practice_patients_age.csv\"),\n    col_types = cols(\n      ORG_CODE = col_character(),\n      AGE_GROUP = col_character(),\n      month = col_character(),\n      year = col_double(),\n      NUMBER_OF_PATIENTS = col_double()\n    )\n  )\n}\n\n\n\n\n\n\nShow the code\ntmap_mode(\"plot\")\n\n\nsf_practices_size &lt;- all_practices |&gt;\n  left_join(\n    all_data_df |&gt;\n      summarise(\n        across(NUMBER_OF_PATIENTS, \\(x) median(x, na.rm = T)),\n        .by = CODE\n      ),\n    by = c(\"code\" = \"CODE\")\n  )\n\nsf_practices_size |&gt;\n  filter(NUMBER_OF_PATIENTS &lt;= quantile(NUMBER_OF_PATIENTS, 0.9, na.rm = T)) |&gt;\n  arrange(-NUMBER_OF_PATIENTS) |&gt;\n  tm_shape() +\n  tm_symbols(\n    fill = \"NUMBER_OF_PATIENTS\",\n    size = \"NUMBER_OF_PATIENTS\",\n    col = NA,\n    size.scale = tm_scale_continuous(values.scale = 0.5),\n    size.legend = tm_legend_hide(),\n    # fill_alpha = 0.4,\n    fill.scale = tm_scale_intervals(n = 5, values = \"-tol.rainbow_wh_br\")\n  )\n\n\n\n\n\n\n\n\n\nAge distribution\n\n\nShow the code\nlibrary(data.table)\npractice_avg_age &lt;- as.data.table(all_data_df_age)[,\n  `:=`(\n    lower = as.numeric(str_extract(AGE_GROUP, \"(?&lt;=(\\\\(|\\\\[))\\\\d{1,2}\")),\n    upper = as.numeric(str_extract(AGE_GROUP, \"\\\\d{2,3}(?=(\\\\)|\\\\]))\"))\n  )\n][,\n  midpoint := 0.5 * (lower + upper)\n][,\n  .(mean_age = weighted.mean(midpoint, NUMBER_OF_PATIENTS)),\n  by = .(ORG_CODE, month, year)\n]\n\n\nNational mean age distribution\n\n\nShow the code\npractice_avg_age |&gt;\n  filter(year == 2024, month == \"december\") |&gt;\n  ggplot(aes(mean_age)) +\n  stat_ecdf() +\n  theme_minimal()\n\n\n\n\n\n\n\n\n\nSpatial distribution\n\n\nShow the code\nsf_practices_age &lt;- all_practices |&gt;\n  left_join(\n    practice_avg_age |&gt;\n      filter(year == 2024, month == \"december\"),\n    by = c(\"code\" = \"ORG_CODE\")\n  ) |&gt;\n  drop_na()\n\nsf_practices_age |&gt;\n  arrange(mean_age) |&gt;\n  ggplot(aes(col = mean_age)) +\n  geom_sf(alpha = 0.7) +\n  theme_void() +\n  scale_color_continuous(palette = \"viridis\")",
    "crumbs": [
      "Data",
      "GP Practices"
    ]
  }
]